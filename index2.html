<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Todo List Planner | Daily & Weekly Productivity</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR:wght@400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap');

    :root {
      --bg: #f3f7ff;
      --surface: #ffffff;
      --surface-soft: #eef3ff;
      --ink: #111a2c;
      --muted: #5b6b85;
      --line: #d4deef;
      --brand: #2f67af;
      --brand-2: #4d83d1;
      --warn: #ef8f24;
      --danger: #d9465f;
      --radius-xl: 26px;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-lg: 0 22px 55px rgba(18, 25, 24, 0.12);
      --shadow-md: 0 10px 28px rgba(18, 25, 24, 0.08);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "IBM Plex Sans KR", "Apple SD Gothic Neo", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 15% -10%, #dce8ff 0, transparent 38%),
        radial-gradient(circle at 85% 0%, #e9f0ff 0, transparent 28%),
        var(--bg);
    }

    .app {
      max-width: 1260px;
      margin: 0 auto;
      padding: 30px 20px 90px;
    }

    .hero {
      border-radius: var(--radius-xl);
      padding: 28px;
      color: #fff;
      background:
        linear-gradient(140deg, rgba(27, 59, 108, 0.95), rgba(47, 103, 175, 0.88)),
        url("https://images.unsplash.com/photo-1517842645767-c639042777db?q=80&w=1400&auto=format&fit=crop") center/cover;
      box-shadow: var(--shadow-lg);
      position: relative;
      overflow: hidden;
      animation: rise 0.6s ease both;
    }

    .hero::before {
      content: "";
      position: absolute;
      inset: auto -120px -100px auto;
      width: 360px;
      height: 360px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.45), rgba(255, 255, 255, 0));
      pointer-events: none;
    }

    .hero-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 18px;
      flex-wrap: wrap;
      position: relative;
      z-index: 2;
    }

    .brand h1 {
      margin: 0;
      font-family: "Outfit", sans-serif;
      font-size: clamp(28px, 4.2vw, 42px);
      letter-spacing: -0.03em;
    }

    .brand p {
      margin: 10px 0 0;
      max-width: 620px;
      line-height: 1.5;
      color: rgba(255, 255, 255, 0.88);
      font-size: 15px;
    }

    .toolbar {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      width: min(360px, 100%);
    }

    .account-card {
      margin-top: 14px;
      border-radius: var(--radius-md);
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.24);
      background: rgba(14, 37, 72, 0.34);
      backdrop-filter: blur(5px);
      position: relative;
      z-index: 2;
      display: grid;
      gap: 8px;
    }

    .account-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      color: rgba(255, 255, 255, 0.94);
      font-size: 12px;
    }

    .account-user {
      font-size: 13px;
      font-weight: 700;
    }

    .account-sync {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 3px 9px;
      border: 1px solid rgba(255, 255, 255, 0.38);
      background: rgba(255, 255, 255, 0.12);
      font-size: 11px;
      color: rgba(255, 255, 255, 0.92);
      white-space: nowrap;
    }

    .account-sync::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #9ad0ff;
      box-shadow: 0 0 0 3px rgba(154, 208, 255, 0.18);
    }

    .account-sync.is-live::before {
      background: #5af0bf;
      box-shadow: 0 0 0 3px rgba(90, 240, 191, 0.22);
    }

    .account-sync.is-saving::before {
      background: #ffcd74;
      box-shadow: 0 0 0 3px rgba(255, 205, 116, 0.22);
    }

    .account-auth {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 8px;
      align-items: center;
    }

    .account-auth input {
      border: 1px solid rgba(255, 255, 255, 0.35);
      border-radius: 10px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.14);
      color: #fff;
      font-size: 13px;
      min-width: 0;
    }

    .account-auth input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }

    .account-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn.small {
      padding: 9px 12px;
      font-size: 12px;
    }

    .auth-help {
      margin: 0;
      color: rgba(255, 255, 255, 0.84);
      font-size: 11px;
      line-height: 1.4;
    }

    .btn {
      border: 0;
      border-radius: 999px;
      padding: 11px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.2s ease;
    }

    .btn:active { transform: translateY(1px); }

    .btn.main {
      background: #fff;
      color: #1f4f94;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.16);
    }

    .btn.ghost {
      background: rgba(255, 255, 255, 0.16);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.36);
    }

    .stats {
      margin-top: 22px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      position: relative;
      z-index: 2;
    }

    .stat {
      border-radius: var(--radius-md);
      padding: 14px;
      background: rgba(255, 255, 255, 0.14);
      border: 1px solid rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(3px);
    }

    .stat .label {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.82);
    }

    .stat .value {
      margin-top: 4px;
      font-size: 24px;
      font-weight: 700;
      font-family: "Outfit", sans-serif;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin: 16px 0 8px;
      flex-wrap: wrap;
    }

    .tab-btn {
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 999px;
      padding: 10px 15px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
    }

    .tab-btn.active {
      background: #2f67af;
      color: #fff;
      border-color: transparent;
      box-shadow: 0 10px 20px rgba(47, 103, 175, 0.24);
    }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    .date-hub {
      margin-top: 10px;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      padding: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .date-hub.is-hidden { display: none; }

    .date-hub .label { font-size: 12px; color: var(--muted); }
    .date-hub .value {
      margin-top: 2px;
      font-family: "Outfit", sans-serif;
      font-size: 24px;
      letter-spacing: -0.02em;
    }
    .date-picker-trigger {
      position: relative;
      width: 42px;
      height: 42px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      display: grid;
      place-items: center;
      font-size: 18px;
      overflow: hidden;
    }
    .date-picker-trigger input[type="date"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .date-nav {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .date-nav-btn {
      width: 42px;
      height: 42px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      color: #2f67af;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
    }

    .layout {
      margin-top: 10px;
      display: grid;
      gap: 14px;
      grid-template-columns: 1.1fr 1fr 1fr;
      align-items: start;
    }
    .split-layout {
      grid-template-columns: 1fr 1fr;
      align-items: stretch;
    }
    .column { display: grid; gap: 14px; align-content: start; }

    .card {
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      padding: 16px;
      animation: rise 0.45s ease both;
    }

    .title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    .card h2,
    .card h3 { margin: 0; font-family: "Outfit", sans-serif; letter-spacing: -0.01em; }

    .sub { color: var(--muted); font-size: 12px; margin: 4px 0 0; }

    .quick-add {
      display: grid;
      gap: 8px;
      grid-template-columns: 1fr 170px auto;
      margin-top: 10px;
    }
    .input-zone {
      border: 1px solid #d8e5ff;
      border-radius: 12px;
      background: #f8fbff;
      padding: 10px;
      margin-top: 10px;
    }
    .tag-manager {
      margin-top: 10px;
      border: 1px dashed #cdd9ee;
      border-radius: 12px;
      padding: 8px 10px;
      background: #f9fbff;
      opacity: 0.92;
    }
    .tag-manager summary {
      cursor: pointer;
      color: #5b6b85;
      font-size: 12px;
      font-weight: 600;
      list-style: none;
    }
    .tag-manager summary::-webkit-details-marker { display: none; }
    .tag-manager .tag-manager-body { margin-top: 8px; }
    .tag-manager[open] { opacity: 1; }
    .tag-manager .sub { margin: 0 0 8px; }
    .tag-manager input, .tag-manager button { height: 36px; }
    .tag-manager .btn.main { padding: 8px 12px; font-size: 12px; }
    .tag-manager .tag-list { margin-top: 6px; }
    .tag-manager .tag-pill { font-size: 11px; }
    .tag-manager .tag-pill button { font-size: 11px; }
    .tag-manager .tag-manager-head {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: nowrap;
      margin-bottom: 8px;
    }
    .tag-manager .tag-manager-head input { flex: 1; min-width: 0; }
    .tag-list {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .tag-pill {
      font-size: 12px;
      border: 1px solid #cde0ff;
      color: #214875;
      background: #ecf3ff;
      border-radius: 999px;
      padding: 5px 8px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .tag-pill button {
      border: 0;
      background: transparent;
      cursor: pointer;
      color: #587ba7;
      padding: 0;
      font-size: 12px;
    }
    .quick-task-row {
      margin-top: 10px;
      display: flex;
      flex-wrap: nowrap;
      gap: 8px;
      overflow-x: auto;
      scrollbar-width: thin;
    }
    .quick-task-btn {
      border: 1px dashed #bfd6ff;
      background: #f2f7ff;
      color: #2b4f7f;
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      cursor: pointer;
    }
    .project-filter { margin-top: 8px; }
    .chip-group.project-filter {
      flex-wrap: nowrap;
      overflow-x: auto;
      white-space: nowrap;
      padding-bottom: 2px;
      scrollbar-width: thin;
    }
    .project-chip {
      font-size: 12px;
      border: 1px solid #bdd3f7;
      background: #eef4ff;
      color: #315b94;
      border-radius: 10px;
      padding: 7px 10px;
      cursor: pointer;
    }
    .project-chip.active {
      background: #d9e7ff;
      border-color: #8eb1e8;
      color: #173f74;
      font-weight: 600;
    }

    input[type="text"], input[type="date"], input[type="month"], textarea, select {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 11px;
      background: #fff;
      color: var(--ink);
      font-size: 13px;
      font-family: inherit;
    }

    textarea { min-height: 140px; resize: vertical; }

    input:focus, textarea:focus, select:focus {
      outline: 2px solid rgba(37, 165, 141, 0.23);
      border-color: var(--brand-2);
    }

    .chip-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .chip {
      font-size: 12px;
      border: 1px solid var(--line);
      background: var(--surface-soft);
      border-radius: 999px;
      padding: 7px 11px;
      cursor: pointer;
    }

    .chip.active {
      border-color: transparent;
      background: #2f67af;
      color: #fff;
      box-shadow: 0 8px 16px rgba(47, 103, 175, 0.24);
    }

    .todo-list {
      display: grid;
      gap: 8px;
      margin-top: 10px;
      max-height: 390px;
      overflow: auto;
      padding-right: 2px;
    }

    .todo-item {
      display: grid;
      grid-template-columns: auto auto 1fr auto;
      gap: 8px;
      align-items: center;
      border: 1px solid var(--line);
      border-radius: 11px;
      padding: 9px;
      background: #fff;
    }

    .todo-item.dragging { opacity: 0.45; }
    .todo-actions { display: flex; gap: 6px; }
    .mini-btn.top-active {
      background: #e9f2ff;
      border-color: #c6dbff;
      color: #244d86;
      font-weight: 600;
    }

    .work-card {
      border: 1px solid #cad7ef;
      background: linear-gradient(180deg, #f7faff, #ffffff 40%);
    }

    .work-top {
      border: 1px solid #d7e4ff;
      border-radius: 12px;
      padding: 10px;
      background: #edf4ff;
      margin-top: 10px;
      font-size: 12px;
      color: #35507a;
    }

    .work-top strong {
      display: block;
      margin-bottom: 4px;
      color: #183968;
      font-family: "Outfit", sans-serif;
      font-size: 13px;
    }

    .drag-handle {
      border: 1px dashed var(--line);
      border-radius: 7px;
      padding: 2px 6px;
      font-size: 14px;
      color: var(--muted);
      cursor: grab;
      user-select: none;
    }

    .todo-item.done { background: #f1f5fb; color: #75839a; }
    .todo-item.done .todo-title { text-decoration: line-through; }
    .todo-title {
      font-size: 14px;
      font-weight: 600;
    }

    .priority {
      display: inline-block;
      font-size: 11px;
      border-radius: 999px;
      padding: 3px 8px;
      font-weight: 600;
    }

    .p-high { background: #ffe9ed; color: #c53f58; }
    .p-mid { background: #fff4e3; color: #ba7a20; }
    .p-low { background: #eaf2ff; color: #2f67af; }

    .todo-meta {
      margin-top: 4px;
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }
    .project-tag {
      font-size: 11px;
      color: #2a4d7f;
      background: #eaf2ff;
      border: 1px solid #cfe0ff;
      border-radius: 999px;
      padding: 3px 8px;
    }
    .top-rank {
      font-size: 11px;
      color: #244d86;
      background: #e4efff;
      border: 1px solid #c6dbff;
      border-radius: 999px;
      padding: 3px 8px;
      font-weight: 600;
    }

    .due {
      font-size: 11px;
      color: #2c5b9a;
      background: #ebf2ff;
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid #cfe0ff;
    }

    .mini-btn {
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 8px;
      padding: 5px 8px;
      font-size: 12px;
      cursor: pointer;
      color: var(--muted);
    }

    .aside { display: grid; gap: 14px; }

    .routine-list { display: grid; gap: 8px; margin-top: 8px; }

    .routine-item {
      border: 1px solid #d5e3fb;
      border-radius: 12px;
      padding: 10px 11px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      background: #f5f8ff;
    }
    .routine-main {
      flex: 1;
      min-width: 0;
    }
    .routine-item.done {
      background: #f1f5fb;
      border-color: #d8e0ef;
    }
    .routine-item.done .routine-name {
      text-decoration: line-through;
      color: #6f8099;
    }

    .life-card {
      border: 1px solid #d5e3fb;
      background: linear-gradient(180deg, #f5f8ff, #ffffff 45%);
    }

    .routine-name {
      border: 0;
      background: transparent;
      padding: 2px 4px;
      font-size: 14px;
      font-weight: 600;
      color: #2d4f80;
      width: 100%;
      min-width: 0;
    }

    .routine-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .routine-actions .mini-btn {
      min-width: 56px;
      white-space: nowrap;
      border-color: #cfe0ff;
      color: #2f5690;
      background: #f1f6ff;
    }
    .routine-empty {
      border: 1px dashed #c9d8ef;
      border-radius: 10px;
      padding: 10px;
      color: #6b7f9d;
      font-size: 12px;
      background: #f7faff;
    }

    .routine-add {
      margin-top: 10px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
    }
    .routine-template-row {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .routine-template-btn {
      border: 1px dashed #bfd6ff;
      background: #f2f7ff;
      color: #2f5690;
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      cursor: pointer;
    }

    .progress-wrap {
      margin-top: 8px;
      background: #eaf0ef;
      border-radius: 999px;
      overflow: hidden;
      height: 10px;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #2f67af, #4d83d1);
      transition: width 0.35s ease;
    }

    .tagline { font-size: 12px; color: var(--muted); margin: 0; }
    .sticker-wrap {
      margin-bottom: 10px;
      display: flex;
      flex-wrap: nowrap;
      gap: 8px;
      overflow-x: auto;
      scrollbar-width: thin;
    }
    .sticker-btn {
      border: 1px solid #cde0ff;
      background: #f3f8ff;
      color: #2a4f7f;
      border-radius: 999px;
      width: 42px;
      height: 42px;
      display: inline-grid;
      place-items: center;
      padding: 0;
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
      flex: 0 0 42px;
    }
    .sticker-btn.active {
      background: #2f67af;
      color: #fff;
      border-color: transparent;
    }

    .calendar-layout {
      margin-top: 10px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
      align-items: start;
    }

    .calendar-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .calendar-legend {
      margin: -2px 0 10px;
      font-size: 11px;
      color: #5a6f8d;
      line-height: 1.35;
    }
    .month-nav-inline {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .month-nav-btn {
      width: 34px;
      height: 34px;
      border: 1px solid #c7d9f4;
      border-radius: 10px;
      background: #f1f6ff;
      color: #2c5f9c;
      font-weight: 700;
      cursor: pointer;
      line-height: 1;
      display: grid;
      place-items: center;
    }
    .month-nav-text {
      min-width: 96px;
      text-align: center;
      font-family: "Outfit", sans-serif;
      font-size: 17px;
      color: #1f4d86;
      letter-spacing: -0.01em;
    }

    .weekday-row, .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 6px;
    }

    .weekday {
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      padding: 4px 0;
    }

    .day-cell {
      min-height: 124px;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px;
      background: #fff;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 6px;
      transition: transform 0.1s ease, border-color 0.15s ease;
    }

    .day-cell:hover { transform: translateY(-1px); }
    .day-cell.muted { opacity: 0.35; cursor: default; }
    .day-cell.today { border-color: #6d9be0; }
    .day-cell.selected { border-color: #2f67af; box-shadow: 0 8px 16px rgba(47, 103, 175, 0.14); }
    .day-cell.routine-partial {
      background: linear-gradient(180deg, #fff7e5, #ffffff 48%);
      border-color: #edc266;
      box-shadow: inset 0 0 0 1px rgba(237, 194, 102, 0.28);
    }
    .day-cell.routine-full {
      background: linear-gradient(180deg, #e9f4ff, #ffffff 52%);
      border-color: #6ea5e2;
      box-shadow: inset 0 0 0 1px rgba(110, 165, 226, 0.25);
    }
    .day-cell.routine-partial .day-num {
      color: #b87400;
    }
    .day-cell.routine-full .day-num {
      color: #1e5f9f;
    }

    .day-num {
      font-family: "Outfit", sans-serif;
      font-size: 15px;
      font-weight: 600;
    }

    .day-meta-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 4px;
    }

    .day-meta {
      font-size: 11px;
      color: #2d5a96;
      border-radius: 8px;
      background: #ecf3ff;
      border: 1px solid #cfe0ff;
      padding: 3px 6px;
      display: inline-flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      width: auto;
      line-height: 1.2;
      min-height: 22px;
      white-space: nowrap;
    }
    .day-meta strong {
      font-family: "Outfit", sans-serif;
      font-size: 11px;
      color: #1d4f87;
      letter-spacing: -0.01em;
    }

    .day-meta.flag {
      background: #eef6ea;
      border-color: #cde8bf;
      color: #2d6b2b;
    }

    .day-meta.flag.off {
      background: #f3f6fb;
      border-color: #d9e2f2;
      color: #6c7c95;
    }
    .day-meta.routine-meta.partial {
      background: #fff2d8;
      border-color: #efc978;
      color: #a66500;
      font-weight: 600;
    }
    .day-meta.routine-meta.full {
      background: #e7f2ff;
      border-color: #8fb8ea;
      color: #1d5d99;
      font-weight: 700;
    }

    .week-kpis {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .week-kpi {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 9px;
      background: #f9fcfb;
    }

    .week-kpi span { font-size: 11px; color: var(--muted); }
    .week-kpi strong { display: block; font-family: "Outfit", sans-serif; font-size: 20px; margin-top: 3px; }
    .report-split {
      display: grid;
      gap: 10px;
    }
    .report-block {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      background: #fff;
    }
    .report-block h4 {
      margin: 0 0 8px;
      font-size: 13px;
      font-family: "Outfit", sans-serif;
    }
    .report-block.work { border-color: #cad7ef; background: #f7faff; }
    .report-block.life { border-color: #d5e3fb; background: #f5f8ff; }

    .day-task-list { display: grid; gap: 8px; margin-top: 10px; }
    .day-task { border: 1px solid var(--line); border-radius: 9px; padding: 8px; background: #fff; font-size: 12px; }
    .analysis-layout {
      margin-top: 10px;
      display: grid;
      gap: 14px;
    }
    .analysis-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .analysis-head input { width: 150px; }
    .analysis-grid {
      display: grid;
      grid-template-columns: 1.15fr 0.85fr;
      gap: 10px;
    }
    .analysis-block {
      border: 1px solid #d3e0f5;
      border-radius: 12px;
      background: #f9fbff;
      padding: 10px;
    }
    .analysis-block h4 {
      margin: 0 0 8px;
      font-size: 13px;
      font-family: "Outfit", sans-serif;
    }
    .routine-analysis-list {
      display: grid;
      gap: 10px;
    }
    .routine-analysis-card {
      border: 1px solid #d7e3f5;
      border-radius: 11px;
      background: #fff;
      padding: 10px;
      display: grid;
      gap: 8px;
    }
    .routine-analysis-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
    }
    .routine-analysis-head strong {
      font-size: 14px;
      color: #1c4478;
    }
    .routine-month-rate {
      color: #24568f;
      border: 1px solid #cfe0ff;
      background: #eef4ff;
      border-radius: 999px;
      padding: 3px 8px;
      font-weight: 600;
    }
    .routine-week-list {
      display: grid;
      gap: 6px;
    }
    .routine-week-line {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      gap: 8px;
      align-items: center;
    }
    .routine-week-dots {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 6px;
    }
    .routine-dot {
      width: 12px;
      height: 12px;
      border-radius: 999px;
      border: 1px solid #bac8e0;
      background: #d5dbe6;
      justify-self: center;
    }
    .routine-dot.done {
      border-color: #3f7ec3;
      background: #2f67af;
      box-shadow: 0 0 0 2px rgba(47, 103, 175, 0.16);
    }
    .routine-dot.empty {
      background: transparent;
      border-color: #e2e7f0;
      box-shadow: none;
    }
    .routine-week-rate {
      font-size: 11px;
      color: #375d8f;
      border: 1px solid #d5e2f7;
      background: #f4f8ff;
      border-radius: 999px;
      padding: 2px 7px;
      min-width: 78px;
      text-align: center;
    }
    .analysis-days {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }
    .analysis-day {
      font-size: 12px;
      border: 1px solid #cbddff;
      color: #274d82;
      background: #eef5ff;
      border-radius: 999px;
      padding: 4px 9px;
    }
    .analysis-day.empty {
      border-color: #d8e2f0;
      background: #f4f7fc;
      color: #77849b;
    }
    .analysis-record-list {
      margin-top: 8px;
      display: grid;
      gap: 8px;
    }
    .analysis-record-item {
      border: 1px solid #d8e3f4;
      border-radius: 10px;
      background: #fff;
      padding: 8px;
      font-size: 12px;
      color: #2a4468;
      line-height: 1.5;
    }
    .analysis-record-item strong {
      display: block;
      margin-bottom: 4px;
      color: #1f4f8b;
      font-family: "Outfit", sans-serif;
      font-size: 12px;
    }
    .analysis-record-item.empty {
      color: #73829b;
      background: #f4f7fc;
      border-color: #d8e2f0;
    }
    .annual-layout {
      margin-top: 10px;
      display: grid;
      gap: 14px;
    }
    .annual-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .annual-head input { width: 120px; }
    .goal-list {
      margin-top: 10px;
      display: grid;
      gap: 10px;
    }
    .goal-card {
      border: 1px solid #d3e0f5;
      border-radius: 12px;
      background: #fff;
      padding: 10px;
      display: grid;
      gap: 8px;
    }
    .goal-head {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: center;
    }
    .goal-head .mini-btn {
      white-space: nowrap;
      border-color: #f0c9d2;
      color: #b23f5a;
      background: #fff6f8;
    }
    .goal-title {
      width: 100%;
      font-weight: 600;
      color: #1f4f8b;
    }
    .goal-content {
      min-height: 88px;
      resize: vertical;
      margin-top: 0;
    }
    .goal-empty {
      border: 1px dashed #c9d8ef;
      border-radius: 10px;
      padding: 10px;
      color: #6b7f9d;
      font-size: 12px;
      background: #f7faff;
    }
    .goal-add-row {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
    }
    .annual-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }
    .annual-card {
      border: 1px solid #cad7ef;
      border-radius: 12px;
      background: #f7faff;
      padding: 10px;
    }
    .annual-card h4 {
      margin: 0 0 8px;
      font-family: "Outfit", sans-serif;
      font-size: 14px;
    }
    .annual-kpi {
      display: grid;
      gap: 6px;
    }
    .annual-kpi span {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #385882;
    }
    .annual-kpi strong { color: #163f73; }

    @keyframes rise {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 1100px) {
      .layout { grid-template-columns: 1fr 1fr; }
      .split-layout { grid-template-columns: 1fr; }
      .calendar-layout { grid-template-columns: 1fr; }
      .analysis-layout { grid-template-columns: 1fr; }
      .analysis-grid { grid-template-columns: 1fr; }
      .annual-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .stats { grid-template-columns: repeat(2, 1fr); }
      .hero { padding: 24px; }
      .account-auth {
        grid-template-columns: 1fr 1fr;
      }
      .account-actions {
        grid-column: span 2;
      }
    }

    @media (max-width: 760px) {
      .app { padding: 16px 14px 72px; }
      .layout { grid-template-columns: 1fr; }
      .quick-add { grid-template-columns: 1fr; }
      .annual-grid { grid-template-columns: 1fr; }
      .btn { width: 100%; }
      .toolbar { width: 100%; }
      .toolbar .btn { width: 100%; }
      .account-auth {
        grid-template-columns: 1fr;
      }
      .account-actions {
        grid-column: auto;
      }
      .account-actions .btn {
        width: auto;
      }
      .routine-add { grid-template-columns: 1fr; }
      .date-hub { align-items: flex-start; }
      .date-nav { width: 100%; justify-content: flex-end; }
      .tag-manager .tag-manager-head { flex-wrap: nowrap; }
      .tag-manager .btn { width: auto; }
      .tabs {
        position: sticky;
        top: 0;
        z-index: 30;
        background: var(--bg);
        padding-top: 6px;
      }
      .date-hub {
        position: sticky;
        top: 58px;
        z-index: 29;
      }
      .chip, .quick-task-btn, .sticker-btn, .routine-template-btn, .mini-btn {
        min-height: 40px;
      }
      .week-kpi span { font-size: 10px; }
      .week-kpi strong { font-size: 17px; }
      input[type="text"], input[type="date"], input[type="month"], textarea, select {
        font-size: 16px;
      }
      .calendar-head {
        margin-bottom: 8px;
      }
      .calendar-head .sub {
        font-size: 11px;
        line-height: 1.42;
      }
      .calendar-legend {
        font-size: 10px;
        margin-bottom: 8px;
      }
      .month-nav-btn {
        width: 32px;
        height: 32px;
      }
      .month-nav-text {
        min-width: 80px;
        font-size: 15px;
      }
      .weekday-row, .calendar-grid {
        gap: 4px;
      }
      .weekday {
        font-size: 11px;
        padding: 3px 0;
      }
      .day-cell {
        min-height: 102px;
        padding: 6px;
        gap: 5px;
      }
      .day-num {
        font-size: 14px;
      }
      .day-meta-grid {
        gap: 3px;
      }
      .day-meta {
        font-size: 9.5px;
        padding: 2px 4px;
        border-radius: 7px;
        min-height: 19px;
      }
      .day-meta strong {
        font-size: 10px;
      }
    }
  </style>
</head>
<body>
  <main class="app">
    <section class="hero">
      <div class="hero-top">
        <div class="brand">
          <h1>Smart Todo Planner</h1>
          <p>ì¼ìƒê³¼ ì—…ë¬´ë¥¼ ì°¨ë¶„í•˜ê²Œ ì •ë¦¬í•  ìˆ˜ ìˆëŠ” í†µí•© í”Œë˜ë„ˆì…ë‹ˆë‹¤. ì˜¤ëŠ˜ í•´ì•¼ í•  ì¼ë¶€í„° ì£¼ê°„ íë¦„, ì—°ê°„ ëˆ„ì ê¹Œì§€ í•œ í™”ë©´ì—ì„œ ë¶€ë“œëŸ½ê³  ëª…í™•í•˜ê²Œ ê´€ë¦¬í•´ë³´ì„¸ìš”.</p>
        </div>
        <div class="toolbar">
          <button class="btn main" id="exportBtn">ë°±ì—… ë‚´ë³´ë‚´ê¸°</button>
          <button class="btn ghost" id="importBtn">ë°±ì—… ê°€ì ¸ì˜¤ê¸°</button>
          <input type="file" id="importFile" accept="application/json" hidden />
        </div>
      </div>
      <div class="account-card">
        <div class="account-head">
          <div class="account-user" id="authStatus">ê²ŒìŠ¤íŠ¸ ëª¨ë“œ</div>
          <div class="account-sync" id="syncStatus">ë¡œì»¬ ì €ì¥ ì „ìš©</div>
        </div>
        <div class="account-auth" id="authForm">
          <input type="email" id="authEmail" placeholder="ì´ë©”ì¼" autocomplete="username" />
          <input type="password" id="authPassword" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" />
          <div class="account-actions">
            <button class="btn main small" id="loginBtn">ë¡œê·¸ì¸</button>
            <button class="btn ghost small" id="signupBtn">íšŒì›ê°€ì…</button>
            <button class="btn ghost small" id="logoutBtn" hidden>ë¡œê·¸ì•„ì›ƒ</button>
          </div>
        </div>
        <p class="auth-help" id="authHelp">ë¡œê·¸ì¸í•˜ë©´ ë‚´ ë°ì´í„°ë§Œ ë¶ˆëŸ¬ì˜¤ê³  ë‹¤ë¥¸ ì‚¬ìš©ìëŠ” ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Firebase ì„¤ì • ì „ì—ëŠ” ë¡œì»¬ ì €ì¥ë§Œ ë™ì‘í•©ë‹ˆë‹¤.</p>
      </div>
      <div class="stats">
        <article class="stat">
          <div class="label">ì„ íƒë‚ ì§œ ë‚¨ì€ í• ì¼</div>
          <div class="value" id="statRemain">0</div>
        </article>
        <article class="stat">
          <div class="label">ì„ íƒë‚ ì§œ ë£¨í‹´ ë‹¬ì„±ìœ¨</div>
          <div class="value" id="statRoutine">0%</div>
        </article>
      </div>
    </section>

    <div class="tabs">
      <button class="tab-btn" data-tab="dashboard">Daily</button>
      <button class="tab-btn active" data-tab="calendar">Calendar</button>
      <button class="tab-btn" data-tab="analysis">Analysis</button>
      <button class="tab-btn" data-tab="annual">Yearly</button>
    </div>

    <section class="date-hub">
      <div class="value" id="activeDateText">0000.00.00</div>
      <div class="date-nav">
        <button class="date-nav-btn" id="prevDateBtn" aria-label="ì´ì „ ë‚ ì§œ">&lt;</button>
        <label class="date-picker-trigger" aria-label="ê¸°ë¡ ê¸°ì¤€ì¼ ì„ íƒ">
          ğŸ“…
          <input type="date" id="globalDatePicker" />
        </label>
        <button class="date-nav-btn" id="nextDateBtn" aria-label="ë‹¤ìŒ ë‚ ì§œ">&gt;</button>
      </div>
    </section>

    <section class="tab-panel" id="panel-dashboard">
      <section class="layout split-layout">
        <div class="column work-column">
          <article class="card work-card" style="animation-delay: 0.05s">
            <div class="title-row">
              <div>
                <h3>Todo List</h3>
                <p class="sub">í”„ë¡œì íŠ¸ íƒœê·¸ë¡œ ë¶„ë¥˜í•˜ê³ , ì¤‘ìš”í•œ Top3ë¥¼ ì§€ì •í•´ ì§‘ì¤‘í•˜ì„¸ìš”.</p>
              </div>
            </div>

            <div class="work-top">
              <strong>Top 3 Priorities</strong>
              <div id="topTaskText">ì•„ì§ ì§€ì •ëœ í•µì‹¬ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>

            <div class="input-zone">
              <p class="sub"><strong>í•  ì¼ ë¹ ë¥¸ ì¶”ê°€</strong> í…ìŠ¤íŠ¸ ì…ë ¥ í›„ ì¶”ê°€í•˜ë©´ ë°”ë¡œ ê¸°ë¡ë©ë‹ˆë‹¤.</p>
              <div class="quick-add">
                <input type="text" id="todoInput" placeholder="ì˜ˆ: í´ë¼ì´ì–¸íŠ¸ ì œì•ˆì„œ ìˆ˜ì •" />
                <select id="todoTagSelect" aria-label="í”„ë¡œì íŠ¸ íƒœê·¸ ì„ íƒ"></select>
                <button class="btn main" id="addTodoBtn">ì¶”ê°€</button>
              </div>
              <div class="quick-task-row" id="quickTaskRow">
                <button class="quick-task-btn" data-template="ë©”ì¼ í™•ì¸/ë‹µë³€">ë©”ì¼ í™•ì¸/ë‹µë³€</button>
                <button class="quick-task-btn" data-template="í•µì‹¬ ë³´ê³ ì„œ 1ê±´">í•µì‹¬ ë³´ê³ ì„œ 1ê±´</button>
              </div>
            </div>
            <details class="tag-manager">
              <summary>ì„ íƒ ì„¤ì •: í”„ë¡œì íŠ¸ íƒœê·¸ ê´€ë¦¬</summary>
              <div class="tag-manager-body">
                <p class="sub">í•„ìš”í•  ë•Œë§Œ ì—´ì–´ íƒœê·¸ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”.</p>
                <div class="tag-manager-head">
                  <input type="text" id="tagInput" placeholder="íƒœê·¸ëŠ” Personal / Workë¡œ ê³ ì •ë©ë‹ˆë‹¤." disabled />
                  <button class="btn main" id="addTagBtn" disabled>ê³ ì •</button>
                </div>
                <div class="tag-list" id="tagList"></div>
              </div>
            </details>

            <div class="chip-group" id="filterChips">
              <button class="chip active" data-filter="all">ì „ì²´</button>
              <button class="chip" data-filter="open">ì§„í–‰ì¤‘</button>
              <button class="chip" data-filter="done">ì™„ë£Œ</button>
            </div>
            <div class="chip-group project-filter" id="projectFilterChips"></div>

            <div class="todo-list" id="todoList"></div>
          </article>

          <article class="card work-card" style="animation-delay: 0.1s">
            <div class="title-row">
              <div>
                <h3>Daily Journal</h3>
                <p class="sub">ì•ˆ ì“°ëŠ” ë‚ ë„ ìŠ¤í‹°ì»¤ í´ë¦­ë§Œìœ¼ë¡œ ë°œìì·¨ë¥¼ ë‚¨ê¸¸ ìˆ˜ ìˆì–´ìš”.</p>
              </div>
            </div>
            <div class="sticker-wrap" id="journalSticker">
              <button class="sticker-btn" data-sticker="ğŸ”¥" title="ëª°ì…" aria-label="ëª°ì…">ğŸ”¥</button>
              <button class="sticker-btn" data-sticker="ğŸ™‚" title="ì•ˆì •" aria-label="ì•ˆì •">ğŸ™‚</button>
              <button class="sticker-btn" data-sticker="ğŸ˜µ" title="ê³¼ë¶€í•˜" aria-label="ê³¼ë¶€í•˜">ğŸ˜µ</button>
              <button class="sticker-btn" data-sticker="ğŸŒ¿" title="íšŒë³µ" aria-label="íšŒë³µ">ğŸŒ¿</button>
              <button class="sticker-btn" data-sticker="ğŸ–" title="íœ´ì‹" aria-label="íœ´ì‹">ğŸ–</button>
            </div>
            <textarea id="journalBody" placeholder="íšŒê³ : ë¬´ì—‡ì´ ì˜ ëê³ , ë¬´ì—‡ì„ ê°œì„ í• ì§€"></textarea>
          </article>
        </div>

        <div class="column life-column">
          <article class="card life-card" style="animation-delay: 0.15s">
            <div class="title-row">
              <div>
                <h3>Habit Tracker</h3>
                <p class="sub">ì²´í¬ëŠ” ë‚ ì§œë³„ë¡œ ë¶„ë¦¬ë˜ë©°, í•˜ë£¨ê°€ ë°”ë€Œë©´ ìë™ìœ¼ë¡œ ì˜¤ëŠ˜ ê¸°ì¤€ìœ¼ë¡œ ë¦¬ì…‹ë©ë‹ˆë‹¤.</p>
              </div>
            </div>
            <div class="routine-list" id="routineList"></div>
            <div class="routine-add">
              <input type="text" id="routineInput" placeholder="ìƒˆ ë£¨í‹´ ì¶”ê°€ (ì˜ˆ: ë¬¼ 2L)" />
              <button class="btn main" id="addRoutineBtn">ì¶”ê°€</button>
            </div>
            <div class="routine-template-row" id="routineTemplateRow">
              <button class="routine-template-btn" data-routines="ë¬¼ 2L|ìŠ¤íŠ¸ë ˆì¹­ 5ë¶„|ê°€ë²¼ìš´ ì •ë¦¬">ì•„ì¹¨ í…œí”Œë¦¿</button>
              <button class="routine-template-btn" data-routines="ì‚°ì±… 20ë¶„|ë¹„íƒ€ë¯¼ ì±™ê¸°ê¸°|ì €ë… íšŒê³ ">ì €ë… í…œí”Œë¦¿</button>
            </div>
            <div class="progress-wrap">
              <div class="progress-bar" id="routineBar"></div>
            </div>
            <p class="tagline" id="routineText">ì˜¤ëŠ˜ ë£¨í‹´ ë‹¬ì„±ë¥  0%</p>
          </article>

          <article class="card life-card">
            <div class="title-row">
              <div>
                <h3>Quick Notes</h3>
                <p class="sub">ì„ íƒí•œ ë‚ ì§œë³„ë¡œ ë‹¤ë¥¸ ë©”ëª¨ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.</p>
              </div>
            </div>
            <textarea id="quickNotes" style="min-height: 180px;" placeholder="ë©”ëª¨, ì•„ì´ë””ì–´, ë‹¤ìŒ ì•¡ì…˜"></textarea>
          </article>
        </div>
      </section>
    </section>

    <section class="tab-panel active" id="panel-calendar">
      <section class="calendar-layout">
        <article class="card work-card">
          <div class="calendar-head">
            <div>
              <h3 style="margin:0;">Canlender</h3>
              <p class="sub">ë‚ ì§œë³„ ì—…ë¬´/ë£¨í‹´/ì €ë„/í€µë…¸íŠ¸ ê¸°ë¡ í˜„í™©ì„ ë¹ ë¥´ê²Œ í™•ì¸í•˜ê³ , í´ë¦­í•˜ë©´ í•´ë‹¹ ë‚ ì§œ Dailyë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
            </div>
            <div class="month-nav-inline">
              <button class="month-nav-btn" id="calendarPrevMonthBtn" aria-label="ì´ì „ ì›”">&lt;</button>
              <div class="month-nav-text" id="calendarMonthText">0000.00</div>
              <button class="month-nav-btn" id="calendarNextMonthBtn" aria-label="ë‹¤ìŒ ì›”">&gt;</button>
            </div>
            <input type="month" id="calendarMonth" hidden />
          </div>
          <p class="calendar-legend">ì£¼í™©: ë£¨í‹´ ì¼ë¶€ ë‹¬ì„±, íŒŒë‘: ë£¨í‹´ ì „ì²´ ë‹¬ì„±, J: ì €ë„, Q: í€µë…¸íŠ¸</p>
          <div class="weekday-row" id="weekdayRow"></div>
          <div class="calendar-grid" id="calendarGrid"></div>
        </article>
      </section>
    </section>

    <section class="tab-panel" id="panel-analysis">
      <section class="analysis-layout">
        <article class="card life-card">
          <div class="analysis-head">
            <div>
              <h3 style="margin:0;">Analysis</h3>
              <p class="sub">ì›” ê¸°ì¤€ìœ¼ë¡œ ë£¨í‹´ ë‹¬ì„±ìœ¨, ê¸°ë¡ì¼, ì‹¤ì œ ê¸°ë¡ ë‚´ìš©ì„ í•œ ë²ˆì— í™•ì¸í•˜ì„¸ìš”.</p>
            </div>
            <div class="month-nav-inline">
              <button class="month-nav-btn" id="analysisPrevMonthBtn" aria-label="ì´ì „ ì›”">&lt;</button>
              <div class="month-nav-text" id="analysisMonthText">0000.00</div>
              <button class="month-nav-btn" id="analysisNextMonthBtn" aria-label="ë‹¤ìŒ ì›”">&gt;</button>
            </div>
            <input type="month" id="analysisMonth" hidden />
          </div>
          <div class="analysis-grid">
            <section class="analysis-block">
              <h4>ë£¨í‹´ ë‹¬ì„±ìœ¨</h4>
              <div class="routine-analysis-list" id="analysisRoutineRows"></div>
            </section>
            <section class="analysis-block">
              <h4>ê¸°ë¡ì¼</h4>
              <div>
                <p class="sub" id="analysisJournalSummary">Journal: -</p>
                <div class="analysis-days" id="analysisJournalDays"></div>
                <div class="analysis-record-list" id="analysisJournalEntries"></div>
              </div>
              <div style="margin-top:10px;">
                <p class="sub" id="analysisQuickSummary">Quick Note: -</p>
                <div class="analysis-days" id="analysisQuickDays"></div>
                <div class="analysis-record-list" id="analysisQuickEntries"></div>
              </div>
            </section>
          </div>
        </article>
      </section>
    </section>

    <section class="tab-panel" id="panel-annual">
      <section class="annual-layout">
        <article class="card work-card">
          <div class="annual-head">
            <div>
              <h3 style="margin:0;">Yearly</h3>
              <p class="sub">ì›”ë³„ í€µë…¸íŠ¸/ì €ë„ ê¸°ë¡ì¼ê³¼ ë£¨í‹´ ë‹¬ì„±ìœ¨ì„ ë¹ ë¥´ê²Œ í™•ì¸í•˜ì„¸ìš”.</p>
            </div>
            <input type="number" id="annualYear" min="2000" max="2100" step="1" />
          </div>
          <div class="goal-list" id="annualGoalList"></div>
          <div class="goal-add-row">
            <button class="btn main small" id="addAnnualGoalBtn">ì¹´í…Œê³ ë¦¬ ì¶”ê°€</button>
          </div>
          <div class="annual-grid" id="annualGrid"></div>
        </article>
      </section>
    </section>
  </main>

  <script src="./firebase-config.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script>
    const STORAGE_KEY_PREFIX = "focus-ledger-v3";
    const LEGACY_STORAGE_KEY = "focus-ledger-v2";
    const STORAGE_VERSION = 3;
    const CLOUD_COLLECTION = "plannerStates";
    const CLOUD_SAVE_DELAY_MS = 900;
    const WEEK_LABELS = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];

    const fixedProjectTags = ["Personal", "Work"];

    const defaultRoutines = [
      { id: "r1", name: "ì•„ì¹¨ í”Œë˜ë‹", done: false },
      { id: "r2", name: "30ë¶„ ìš´ë™", done: false },
      { id: "r3", name: "ì§‘ì¤‘ ë…ì„œ 20ë¶„", done: false },
      { id: "r4", name: "ì €ë… íšŒê³ ", done: false }
    ];

    function todayKey() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, "0");
      const d = String(now.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function thisMonthKey() {
      return todayKey().slice(0, 7);
    }

    // To enable account login/sync, inject `window.PLANNER_FIREBASE_CONFIG` with real project values.
    const firebaseConfig = window.PLANNER_FIREBASE_CONFIG || {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    function createDefaultState() {
      return {
        activeTab: "calendar",
        todos: [],
        filter: "all",
        projectFilter: "all",
        selectedDate: todayKey(),
        calendarMonth: thisMonthKey(),
        analysisMonth: thisMonthKey(),
        annualYear: new Date().getFullYear(),
        annualGoal: "",
        annualGoals: [],
        projectTags: [...fixedProjectTags],
        quickNotesByDate: {},
        routines: defaultRoutines.map((r) => ({ ...r })),
        routineLogs: {},
        dailyLogs: {},
        journals: {},
        lastSeenDate: todayKey(),
        updatedAt: 0
      };
    }

    const state = createDefaultState();

    let activeStorageKey = `${STORAGE_KEY_PREFIX}:guest`;
    let cloudEnabled = false;
    let cloudInitialized = false;
    let cloudAuth = null;
    let cloudDb = null;
    let authUser = null;
    let cloudSaveTimer = null;
    let isApplyingRemoteState = false;

    const el = {
      tabButtons: [...document.querySelectorAll(".tab-btn")],
      tabPanels: [...document.querySelectorAll(".tab-panel")],
      dateHub: document.querySelector(".date-hub"),
      activeDateText: document.getElementById("activeDateText"),
      globalDatePicker: document.getElementById("globalDatePicker"),
      prevDateBtn: document.getElementById("prevDateBtn"),
      nextDateBtn: document.getElementById("nextDateBtn"),
      todoInput: document.getElementById("todoInput"),
      todoTagSelect: document.getElementById("todoTagSelect"),
      topTaskText: document.getElementById("topTaskText"),
      addTodoBtn: document.getElementById("addTodoBtn"),
      quickTaskRow: document.getElementById("quickTaskRow"),
      tagInput: document.getElementById("tagInput"),
      addTagBtn: document.getElementById("addTagBtn"),
      tagList: document.getElementById("tagList"),
      todoList: document.getElementById("todoList"),
      filterChips: document.getElementById("filterChips"),
      projectFilterChips: document.getElementById("projectFilterChips"),
      journalSticker: document.getElementById("journalSticker"),
      journalBody: document.getElementById("journalBody"),
      quickNotes: document.getElementById("quickNotes"),
      routineList: document.getElementById("routineList"),
      routineInput: document.getElementById("routineInput"),
      addRoutineBtn: document.getElementById("addRoutineBtn"),
      routineTemplateRow: document.getElementById("routineTemplateRow"),
      routineBar: document.getElementById("routineBar"),
      routineText: document.getElementById("routineText"),
      statRemain: document.getElementById("statRemain"),
      statRoutine: document.getElementById("statRoutine"),
      exportBtn: document.getElementById("exportBtn"),
      importBtn: document.getElementById("importBtn"),
      importFile: document.getElementById("importFile"),
      calendarMonthText: document.getElementById("calendarMonthText"),
      calendarPrevMonthBtn: document.getElementById("calendarPrevMonthBtn"),
      calendarNextMonthBtn: document.getElementById("calendarNextMonthBtn"),
      calendarMonth: document.getElementById("calendarMonth"),
      analysisMonthText: document.getElementById("analysisMonthText"),
      analysisPrevMonthBtn: document.getElementById("analysisPrevMonthBtn"),
      analysisNextMonthBtn: document.getElementById("analysisNextMonthBtn"),
      analysisMonth: document.getElementById("analysisMonth"),
      weekdayRow: document.getElementById("weekdayRow"),
      calendarGrid: document.getElementById("calendarGrid"),
      annualYear: document.getElementById("annualYear"),
      annualGoalList: document.getElementById("annualGoalList"),
      addAnnualGoalBtn: document.getElementById("addAnnualGoalBtn"),
      annualGrid: document.getElementById("annualGrid"),
      analysisRoutineRows: document.getElementById("analysisRoutineRows"),
      analysisJournalSummary: document.getElementById("analysisJournalSummary"),
      analysisJournalDays: document.getElementById("analysisJournalDays"),
      analysisJournalEntries: document.getElementById("analysisJournalEntries"),
      analysisQuickSummary: document.getElementById("analysisQuickSummary"),
      analysisQuickDays: document.getElementById("analysisQuickDays"),
      analysisQuickEntries: document.getElementById("analysisQuickEntries"),
      dayTaskTitle: document.getElementById("dayTaskTitle"),
      dayTaskList: document.getElementById("dayTaskList"),
      authStatus: document.getElementById("authStatus"),
      syncStatus: document.getElementById("syncStatus"),
      authHelp: document.getElementById("authHelp"),
      authEmail: document.getElementById("authEmail"),
      authPassword: document.getElementById("authPassword"),
      loginBtn: document.getElementById("loginBtn"),
      signupBtn: document.getElementById("signupBtn"),
      logoutBtn: document.getElementById("logoutBtn")
    };

    function emptyJournal() {
      return {
        sticker: "",
        journalBody: ""
      };
    }

    function isDoneValue(value) {
      if (value === true || value === 1) return true;
      if (typeof value === "string") {
        const normalized = value.trim().toLowerCase();
        return normalized === "true" || normalized === "1" || normalized === "yes" || normalized === "y";
      }
      return false;
    }

    function createAnnualGoalCategory(seed = Date.now()) {
      return {
        id: `goal-${seed}-${Math.random().toString(16).slice(2, 6)}`,
        title: "",
        body: ""
      };
    }

    function normalizeAnnualGoals(input) {
      if (!Array.isArray(input)) return [];
      return input
        .map((item, index) => {
          if (!item || typeof item !== "object") return null;
          return {
            id: String(item.id || `goal-${Date.now()}-${index}`),
            title: String(item.title || "").trim(),
            body: String(item.body || "")
          };
        })
        .filter(Boolean);
    }

    function normalizeRoutineLogs(input) {
      const source = input && typeof input === "object" ? input : {};
      const normalized = {};
      Object.entries(source).forEach(([dKey, day]) => {
        if (!isDateKey(dKey) || !day || typeof day !== "object") return;
        const dayNormalized = {};
        Object.entries(day).forEach(([rid, value]) => {
          dayNormalized[rid] = isDoneValue(value);
        });
        normalized[dKey] = dayNormalized;
      });
      return normalized;
    }

    function getJournalForDate(dKey) {
      const current = state.journals[dKey];
      return { ...emptyJournal(), ...(current && typeof current === "object" ? current : {}) };
    }

    function saveJournalField(key, value) {
      const dKey = state.selectedDate;
      const journal = getJournalForDate(dKey);
      journal[key] = value;
      state.journals[dKey] = journal;
    }

    function getQuickNotesForDate(dKey) {
      const value = state.quickNotesByDate[dKey];
      return typeof value === "string" ? value : "";
    }

    function saveQuickNotesForSelectedDate(value) {
      const dKey = state.selectedDate;
      const next = String(value || "");
      if (next.trim()) {
        state.quickNotesByDate[dKey] = next;
        return;
      }
      delete state.quickNotesByDate[dKey];
    }

    function refreshDailyLogForSelectedDate() {
      const dKey = state.selectedDate;
      const journal = getJournalForDate(dKey);
      const routineTotal = state.routines.length;
      const routineDone = state.routines.filter((r) => r.done).length;
      state.dailyLogs[dKey] = {
        workLogged: Boolean((journal.journalBody || "").trim() || journal.sticker),
        routineRate: routineTotal ? Math.round((routineDone / routineTotal) * 100) : 0
      };
    }

    function isDateKey(value) {
      return /^\d{4}-\d{2}-\d{2}$/.test(String(value || ""));
    }

    function storageKeyForUid(uid) {
      return `${STORAGE_KEY_PREFIX}:${uid || "guest"}`;
    }

    function resetState(nextState) {
      const base = createDefaultState();
      Object.keys(state).forEach((key) => delete state[key]);
      Object.assign(state, base, nextState || {});
    }

    function parseStoredPayload(payload) {
      if (!payload || typeof payload !== "object") return null;
      return payload.data && typeof payload.data === "object" ? payload.data : payload;
    }

    function extractUpdatedAt(payload) {
      if (!payload || typeof payload !== "object") return 0;
      const direct = Number(payload.updatedAt) || 0;
      if (direct) return direct;
      if (payload.data && typeof payload.data === "object") {
        return Number(payload.data.updatedAt) || 0;
      }
      return 0;
    }

    function readRawLocalPayload(storageKey = activeStorageKey) {
      try {
        const raw = localStorage.getItem(storageKey);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === "object" ? parsed : null;
      } catch (err) {
        console.warn("ì €ì¥ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨", err);
        return null;
      }
    }

    function shouldResetToToday(parsed, forceToday) {
      if (forceToday) return true;
      const today = todayKey();
      const savedDay = isDateKey(parsed.lastSeenDate) ? parsed.lastSeenDate : "";
      if (!savedDay) {
        return isDateKey(parsed.selectedDate) && parsed.selectedDate !== today;
      }
      return savedDay !== today;
    }

    function applyLoadedState(rawPayload, options = {}) {
      const parsed = parseStoredPayload(rawPayload);
      if (!parsed || typeof parsed !== "object") {
        resetState();
        return;
      }

      const today = todayKey();
      const forceToday = shouldResetToToday(parsed, Boolean(options.forceToday));
      const selectedDate = forceToday
        ? today
        : (isDateKey(parsed.selectedDate) ? parsed.selectedDate : today);

      const quickNotesByDate = parsed.quickNotesByDate && typeof parsed.quickNotesByDate === "object"
        ? { ...parsed.quickNotesByDate }
        : {};

      const legacyQuick = typeof parsed.quickNotes === "string" ? parsed.quickNotes : "";
      if (legacyQuick.trim()) {
        const legacyDate = isDateKey(parsed.selectedDate) ? parsed.selectedDate : today;
        if (!quickNotesByDate[legacyDate]) quickNotesByDate[legacyDate] = legacyQuick;
      }

      const next = {
        activeTab: options.forceLandingCalendar ? "calendar" : (parsed.activeTab || "calendar"),
        todos: Array.isArray(parsed.todos) ? parsed.todos : [],
        filter: ["all", "open", "done"].includes(parsed.filter) ? parsed.filter : "all",
        projectFilter: parsed.projectFilter || "all",
        selectedDate,
        calendarMonth: forceToday
          ? today.slice(0, 7)
          : (typeof parsed.calendarMonth === "string" && parsed.calendarMonth ? parsed.calendarMonth : selectedDate.slice(0, 7)),
        analysisMonth: typeof parsed.analysisMonth === "string" && parsed.analysisMonth
          ? parsed.analysisMonth
          : (typeof parsed.calendarMonth === "string" && parsed.calendarMonth ? parsed.calendarMonth : today.slice(0, 7)),
        annualYear: Number(parsed.annualYear) || new Date(selectedDate).getFullYear(),
        annualGoal: parsed.annualGoal || "",
        annualGoals: normalizeAnnualGoals(parsed.annualGoals),
        projectTags: Array.isArray(parsed.projectTags) && parsed.projectTags.length ? parsed.projectTags : [...fixedProjectTags],
        quickNotesByDate,
        routines: Array.isArray(parsed.routines) && parsed.routines.length
          ? parsed.routines.map((r) => ({ ...r }))
          : defaultRoutines.map((r) => ({ ...r })),
        routineLogs: normalizeRoutineLogs(parsed.routineLogs),
        dailyLogs: parsed.dailyLogs && typeof parsed.dailyLogs === "object" ? parsed.dailyLogs : {},
        journals: parsed.journals && typeof parsed.journals === "object" ? parsed.journals : {},
        lastSeenDate: today,
        updatedAt: Number(parsed.updatedAt) || 0
      };

      const legacyExists = parsed.journalWork || parsed.journalBody || parsed.winOfDay;
      if (legacyExists && !next.journals[today]) {
        next.journals[today] = {
          sticker: "",
          journalBody: parsed.journalBody || parsed.journalWork || parsed.winOfDay || ""
        };
      }
      if (!next.annualGoals.length && String(next.annualGoal || "").trim()) {
        next.annualGoals.push({
          ...createAnnualGoalCategory(),
          title: "ê¸°ë³¸ ëª©í‘œ",
          body: String(next.annualGoal || "")
        });
      }
      next.annualGoal = "";

      resetState(next);
      normalizeTags();
      normalizeTodos();
      syncRoutinesFromSelectedDate();
    }

    function buildStateSnapshot() {
      persistRoutinesForSelectedDate();
      refreshDailyLogForSelectedDate();
      state.lastSeenDate = todayKey();
      state.updatedAt = Date.now();
      return {
        version: STORAGE_VERSION,
        updatedAt: state.updatedAt,
        activeTab: state.activeTab,
        todos: state.todos,
        filter: state.filter,
        projectFilter: state.projectFilter,
        selectedDate: state.selectedDate,
        calendarMonth: state.calendarMonth,
        analysisMonth: state.analysisMonth,
        annualYear: state.annualYear,
        annualGoal: "",
        annualGoals: state.annualGoals,
        projectTags: state.projectTags,
        quickNotesByDate: state.quickNotesByDate,
        routines: state.routines,
        routineLogs: state.routineLogs,
        dailyLogs: state.dailyLogs,
        journals: state.journals,
        lastSeenDate: state.lastSeenDate
      };
    }

    function saveLocalSnapshot(snapshot) {
      try {
        localStorage.setItem(activeStorageKey, JSON.stringify(snapshot));
      } catch (err) {
        console.warn("ë¡œì»¬ ì €ì¥ ì‹¤íŒ¨", err);
      }
    }

    function setSyncStatus(text, mode = "") {
      if (!el.syncStatus) return;
      el.syncStatus.textContent = text;
      el.syncStatus.classList.toggle("is-live", mode === "live");
      el.syncStatus.classList.toggle("is-saving", mode === "saving");
    }

    function queueCloudSave(snapshot) {
      if (!cloudEnabled || !cloudInitialized || !cloudDb || !authUser || isApplyingRemoteState) return;
      if (cloudSaveTimer) clearTimeout(cloudSaveTimer);
      setSyncStatus("í´ë¼ìš°ë“œ ì €ì¥ ëŒ€ê¸°...", "saving");
      cloudSaveTimer = window.setTimeout(async () => {
        try {
          setSyncStatus("í´ë¼ìš°ë“œ ì €ì¥ ì¤‘...", "saving");
          await cloudDb.collection(CLOUD_COLLECTION).doc(authUser.uid).set({
            version: STORAGE_VERSION,
            updatedAt: snapshot.updatedAt,
            data: snapshot
          }, { merge: true });
          setSyncStatus("í´ë¼ìš°ë“œ ë™ê¸°í™” í™œì„±", "live");
        } catch (err) {
          console.warn("í´ë¼ìš°ë“œ ì €ì¥ ì‹¤íŒ¨", err);
          setSyncStatus("í´ë¼ìš°ë“œ ì €ì¥ ì‹¤íŒ¨", "");
        }
      }, CLOUD_SAVE_DELAY_MS);
    }

    function save(options = {}) {
      const snapshot = buildStateSnapshot();
      saveLocalSnapshot(snapshot);
      if (!options.skipCloud) queueCloudSave(snapshot);
      if (el.analysisRoutineRows) renderAnalysis();
      if (el.annualGrid) renderAnnualOverview();
    }

    function load(options = {}) {
      const payload = readRawLocalPayload(activeStorageKey);
      if (!payload && options.allowLegacyGuest) {
        const legacy = readRawLocalPayload(LEGACY_STORAGE_KEY);
        if (legacy) {
          applyLoadedState(legacy, options);
          save({ skipCloud: true });
          return true;
        }
      }
      if (!payload) {
        resetState();
        return false;
      }
      applyLoadedState(payload, options);
      return true;
    }

    function renderAll() {
      syncInputs();
      renderTodos();
      renderRoutines();
      renderCalendar();
      renderSelectedDayTasks();
      renderMonthlyReport();
      renderAnalysis();
      renderAnnualGoals();
      renderAnnualOverview();
    }

    function resetToTodayIfDateRolledOver() {
      const today = todayKey();
      if (state.lastSeenDate === today) return;
      state.selectedDate = today;
      state.calendarMonth = today.slice(0, 7);
      syncRoutinesFromSelectedDate();
      save();
      renderAll();
    }

    function isFirebaseConfigValid(config) {
      if (!config || typeof config !== "object") return false;
      const required = ["apiKey", "authDomain", "projectId", "appId"];
      return required.every((key) => {
        const value = String(config[key] || "");
        return value && !value.includes("YOUR_");
      });
    }

    function updateAuthUI() {
      const loggedIn = Boolean(authUser);
      if (el.loginBtn) el.loginBtn.hidden = loggedIn || !cloudEnabled;
      if (el.signupBtn) el.signupBtn.hidden = loggedIn || !cloudEnabled;
      if (el.logoutBtn) el.logoutBtn.hidden = !loggedIn || !cloudEnabled;
      if (el.authEmail) el.authEmail.disabled = loggedIn || !cloudEnabled;
      if (el.authPassword) el.authPassword.disabled = loggedIn || !cloudEnabled;

      if (!cloudEnabled) {
        el.authStatus.textContent = "ê²ŒìŠ¤íŠ¸ ëª¨ë“œ";
        el.authHelp.textContent = "Firebase ì„¤ì • í›„ ë¡œê·¸ì¸í•˜ë©´ ë‚´ ê³„ì • ë°ì´í„°ê°€ ê¸°ê¸° ê°„ ë™ê¸°í™”ë©ë‹ˆë‹¤.";
        setSyncStatus("ë¡œì»¬ ì €ì¥ ì „ìš©");
        return;
      }

      if (!loggedIn) {
        el.authStatus.textContent = "ê²ŒìŠ¤íŠ¸ ëª¨ë“œ";
        el.authHelp.textContent = "ë¡œê·¸ì¸í•˜ë©´ ë‚´ ë°ì´í„°ë§Œ ë¶ˆëŸ¬ì˜¤ê³ , ë‹¤ë¥¸ ì‚¬ìš©ìëŠ” ë‚´ ë‚´ìš©ì„ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        setSyncStatus("ë¡œê·¸ì¸ í•„ìš”");
        return;
      }

      const label = authUser.email || "ë‚´ ê³„ì •";
      el.authStatus.textContent = `ë¡œê·¸ì¸: ${label}`;
      el.authHelp.textContent = "í˜„ì¬ ê³„ì • ì „ìš© ë°ì´í„°ê°€ ì—´ë ¤ ìˆìŠµë‹ˆë‹¤.";
    }

    function toAuthErrorMessage(err) {
      const code = err && err.code ? String(err.code) : "";
      if (code.includes("invalid-email")) return "ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      if (code.includes("user-not-found")) return "ë“±ë¡ë˜ì§€ ì•Šì€ ê³„ì •ì…ë‹ˆë‹¤.";
      if (code.includes("wrong-password")) return "ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      if (code.includes("email-already-in-use")) return "ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤.";
      if (code.includes("weak-password")) return "ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒìœ¼ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
      if (code.includes("too-many-requests")) return "ë¡œê·¸ì¸ ì‹œë„ê°€ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
      return "ì¸ì¦ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
    }

    async function handleAuthStateChanged(user) {
      authUser = user || null;
      activeStorageKey = storageKeyForUid(authUser ? authUser.uid : "guest");

      if (!authUser) {
        load({ allowLegacyGuest: true, forceToday: false, forceLandingCalendar: true });
        updateAuthUI();
        renderAll();
        return;
      }

      load({ allowLegacyGuest: false, forceToday: false, forceLandingCalendar: true });
      renderAll();
      updateAuthUI();
      setSyncStatus("í´ë¼ìš°ë“œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...", "saving");

      try {
        const doc = await cloudDb.collection(CLOUD_COLLECTION).doc(authUser.uid).get();
        const cloudPayload = doc.exists ? doc.data() : null;
        const localPayload = readRawLocalPayload(activeStorageKey);
        const cloudUpdatedAt = extractUpdatedAt(cloudPayload);
        const localUpdatedAt = extractUpdatedAt(localPayload);

        if (cloudPayload && cloudUpdatedAt >= localUpdatedAt) {
          isApplyingRemoteState = true;
          applyLoadedState(cloudPayload, { forceToday: false });
          isApplyingRemoteState = false;
          save({ skipCloud: true });
          renderAll();
        } else if (!cloudPayload || localUpdatedAt > cloudUpdatedAt) {
          save();
        }

        setSyncStatus("í´ë¼ìš°ë“œ ë™ê¸°í™” í™œì„±", "live");
      } catch (err) {
        console.warn("í´ë¼ìš°ë“œ ë¡œë“œ ì‹¤íŒ¨", err);
        setSyncStatus("í´ë¼ìš°ë“œ ì—°ê²° ì‹¤íŒ¨", "");
      }
    }

    function initCloud() {
      if (!isFirebaseConfigValid(firebaseConfig) || !window.firebase) {
        cloudEnabled = false;
        cloudInitialized = false;
        updateAuthUI();
        return;
      }

      try {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        cloudAuth = firebase.auth();
        cloudDb = firebase.firestore();
        cloudEnabled = true;
        cloudInitialized = true;
        updateAuthUI();
        cloudAuth.onAuthStateChanged((user) => {
          handleAuthStateChanged(user);
        });
      } catch (err) {
        console.warn("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨", err);
        cloudEnabled = false;
        cloudInitialized = false;
        updateAuthUI();
      }
    }

    function escapeHTML(value) {
      return String(value)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function normalizeTodos() {
      state.todos = state.todos.map((t) => ({
        ...t,
        dueDate: t.dueDate || state.selectedDate,
        tag: state.projectTags.includes(t.tag) ? t.tag : (state.projectTags[0] || "Personal"),
        topOrder: Number.isInteger(t.topOrder) ? t.topOrder : 0,
        isTop: false
      }));
      recomputeTopFlags();
    }

    function normalizeTags() {
      state.projectTags = [...fixedProjectTags];
    }

    function recomputeTopFlags() {
      const grouped = {};
      state.todos.forEach((t) => {
        if (!grouped[t.dueDate]) grouped[t.dueDate] = [];
        grouped[t.dueDate].push(t);
      });
      Object.values(grouped).forEach((list) => {
        list.sort((a, b) => (a.topOrder || 0) - (b.topOrder || 0));
        let order = 1;
        list.forEach((t) => {
          if (t.topOrder > 0 && order <= 3) {
            t.topOrder = order;
            t.isTop = true;
            order += 1;
          } else {
            t.topOrder = 0;
            t.isTop = false;
          }
        });
      });
    }

    function syncRoutinesFromSelectedDate() {
      const day = state.routineLogs[state.selectedDate] || {};
      state.routines.forEach((r) => {
        r.done = isDoneValue(day[r.id]);
      });
    }

    function persistRoutinesForSelectedDate() {
      if (!state.routineLogs[state.selectedDate]) state.routineLogs[state.selectedDate] = {};
      state.routines.forEach((r) => {
        state.routineLogs[state.selectedDate][r.id] = Boolean(r.done);
      });
    }

    function renderTagOptions() {
      el.todoTagSelect.innerHTML = state.projectTags.map((t) => `<option value="${escapeHTML(t)}">${escapeHTML(t)}</option>`).join("");
    }

    function renderTagList() {
      el.tagList.innerHTML = state.projectTags.map((t) => `<span class="tag-pill">${escapeHTML(t)}</span>`).join("");
    }

    function renderProjectFilters() {
      const chips = ['<button class="project-chip" data-project-filter="all">íƒœê·¸ ì „ì²´</button>']
        .concat(state.projectTags.map((tag) => `<button class="project-chip" data-project-filter="${escapeHTML(tag)}">${escapeHTML(tag)}</button>`));
      el.projectFilterChips.innerHTML = chips.join("");
      [...el.projectFilterChips.querySelectorAll(".project-chip")].forEach((chip) => {
        chip.classList.toggle("active", chip.dataset.projectFilter === state.projectFilter);
      });
    }

    function setActiveTab(tab, persist = true) {
      const prevTab = state.activeTab;
      state.activeTab = tab;
      if (tab === "analysis" && prevTab !== "analysis") {
        state.analysisMonth = state.calendarMonth;
      }
      el.tabButtons.forEach((btn) => btn.classList.toggle("active", btn.dataset.tab === tab));
      el.tabPanels.forEach((panel) => panel.classList.toggle("active", panel.id === `panel-${tab}`));
      if (el.dateHub) {
        el.dateHub.classList.toggle("is-hidden", tab !== "dashboard");
      }
      if (el.analysisMonth) el.analysisMonth.value = state.analysisMonth;
      if (el.analysisMonthText) el.analysisMonthText.textContent = formatMonthDot(state.analysisMonth);
      if (tab === "analysis") renderAnalysis();
      if (persist) save();
    }

    function renderTodos() {
      const scoped = state.todos.filter((t) => t.dueDate === state.selectedDate);
      let filtered = scoped;
      if (state.filter === "open") filtered = scoped.filter((t) => !t.done);
      if (state.filter === "done") filtered = scoped.filter((t) => t.done);
      if (state.projectFilter !== "all") filtered = filtered.filter((t) => t.tag === state.projectFilter);

      if (!filtered.length) {
        el.todoList.innerHTML = '<div class="sub">í‘œì‹œí•  í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        renderTopTask();
        updateStats();
        return;
      }

      el.todoList.innerHTML = filtered.map((todo) => {
        const tagHtml = todo.tag ? `<span class="project-tag">${escapeHTML(todo.tag)}</span>` : "";
        const topHtml = todo.topOrder > 0 ? `<span class="top-rank">Top${todo.topOrder}</span>` : "";
        return `
          <article class="todo-item ${todo.done ? "done" : ""}" data-id="${todo.id}" draggable="true">
            <span class="drag-handle" title="ë“œë˜ê·¸ ì •ë ¬">::</span>
            <input type="checkbox" ${todo.done ? "checked" : ""} aria-label="todo ì™„ë£Œ" data-action="toggle">
            <div>
              <div class="todo-title">${escapeHTML(todo.text)}</div>
              <div class="todo-meta">
                ${tagHtml}
                <span class="due">${todo.dueDate}</span>
                ${topHtml}
              </div>
            </div>
            <div class="todo-actions">
              <button class="mini-btn ${todo.isTop ? "top-active" : ""}" data-action="top">${todo.isTop ? "í•´ì œ" : "Top3"}</button>
              <button class="mini-btn" data-action="delete">ì‚­ì œ</button>
            </div>
          </article>
        `;
      }).join("");

      renderTopTask();
      updateStats();
      bindTodoDragEvents();
    }

    function renderTopTask() {
      const tops = state.todos
        .filter((t) => t.dueDate === state.selectedDate && t.topOrder > 0)
        .sort((a, b) => a.topOrder - b.topOrder);
      if (!tops.length) {
        el.topTaskText.textContent = "ì•„ì§ ì§€ì •ëœ í•µì‹¬ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }
      el.topTaskText.innerHTML = tops.map((t) => `Top${t.topOrder}. ${escapeHTML(t.text)}`).join("<br>");
    }

    function updateStats() {
      const dayTodos = state.todos.filter((t) => t.dueDate === state.selectedDate);
      const total = dayTodos.length;
      const done = dayTodos.filter((t) => t.done).length;
      const remain = total - done;
      const routineTotal = state.routines.length;
      const routineDone = state.routines.filter((r) => r.done).length;
      const routineRate = routineTotal ? Math.round((routineDone / routineTotal) * 100) : 0;

      el.statRemain.textContent = String(remain);
      el.statRoutine.textContent = `${routineRate}%`;
    }

    function renderRoutines() {
      syncRoutinesFromSelectedDate();
      const total = state.routines.length;
      const done = state.routines.filter((r) => r.done).length;
      const ratio = total ? Math.round((done / total) * 100) : 0;
      const routines = state.routines;

      if (!routines.length) {
        el.routineList.innerHTML = '<div class="routine-empty">ë“±ë¡ëœ ë£¨í‹´ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      } else {
        el.routineList.innerHTML = routines.map((r) => `
          <div class="routine-item ${r.done ? "done" : ""}" data-rid="${r.id}">
            <div class="routine-main">
              <input class="routine-name" type="text" value="${escapeHTML(r.name)}" aria-label="ë£¨í‹´ ì´ë¦„">
            </div>
            <div class="routine-actions">
              <button class="mini-btn" data-toggle-routine="${r.id}">${r.done ? "ë³µì›" : "ì™„ë£Œ"}</button>
              <button class="mini-btn" data-delete-routine="${r.id}">ì‚­ì œ</button>
            </div>
          </div>
        `).join("");
      }

      el.routineBar.style.width = `${ratio}%`;
      el.routineText.textContent = `ì˜¤ëŠ˜ ë£¨í‹´ ë‹¬ì„±ë¥  ${ratio}%`;
      updateStats();
    }

    function syncInputs() {
      const journal = getJournalForDate(state.selectedDate);
      el.globalDatePicker.value = state.selectedDate;
      el.activeDateText.textContent = formatDateDot(state.selectedDate);
      el.journalBody.value = journal.journalBody;
      renderTagOptions();
      renderTagList();
      renderProjectFilters();
      el.quickNotes.value = getQuickNotesForDate(state.selectedDate);
      if (el.calendarMonth) el.calendarMonth.value = state.calendarMonth;
      if (el.calendarMonthText) el.calendarMonthText.textContent = formatMonthDot(state.calendarMonth);
      if (el.analysisMonth) el.analysisMonth.value = state.analysisMonth;
      if (el.analysisMonthText) el.analysisMonthText.textContent = formatMonthDot(state.analysisMonth);
      el.annualYear.value = String(state.annualYear);

      [...el.filterChips.querySelectorAll(".chip")].forEach((chip) => {
        chip.classList.toggle("active", chip.dataset.filter === state.filter);
      });

      setActiveTab(state.activeTab || "calendar", false);

      [...el.journalSticker.querySelectorAll(".sticker-btn")].forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.sticker === journal.sticker);
      });
    }

    function addTodo() {
      const text = el.todoInput.value.trim();
      if (!text) return;

      const dueDate = state.selectedDate || todayKey();
      state.todos.unshift({
        id: `${Date.now()}-${Math.random().toString(16).slice(2, 7)}`,
        text,
        tag: el.todoTagSelect.value || state.projectTags[0] || "Personal",
        priority: "mid",
        dueDate,
        topOrder: 0,
        isTop: false,
        done: false
      });

      el.todoInput.value = "";
      save();
      renderTodos();
      renderCalendar();
      renderSelectedDayTasks();
      renderMonthlyReport();
    }

    function addTodoByTemplate(text) {
      const value = String(text || "").trim();
      if (!value) return;
      state.todos.unshift({
        id: `${Date.now()}-${Math.random().toString(16).slice(2, 7)}`,
        text: value,
        tag: el.todoTagSelect.value || state.projectTags[0] || "Personal",
        priority: "mid",
        dueDate: state.selectedDate,
        topOrder: 0,
        isTop: false,
        done: false
      });
      save();
      renderTodos();
      renderCalendar();
      renderSelectedDayTasks();
      renderMonthlyReport();
    }

    function addRoutine() {
      const name = el.routineInput.value.trim();
      if (!name) return;
      state.routines.push({
        id: `r-${Date.now()}-${Math.random().toString(16).slice(2, 6)}`,
        name,
        done: false
      });
      el.routineInput.value = "";
      save();
      renderRoutines();
      renderCalendar();
      renderMonthlyReport();
    }

    function addRoutineTemplate(raw) {
      const items = String(raw || "")
        .split("|")
        .map((s) => s.trim())
        .filter(Boolean);
      if (!items.length) return;
      const names = new Set(state.routines.map((r) => r.name));
      items.forEach((name) => {
        if (names.has(name)) return;
        state.routines.push({
          id: `r-${Date.now()}-${Math.random().toString(16).slice(2, 6)}`,
          name,
          done: false
        });
        names.add(name);
      });
      save();
      renderRoutines();
      renderCalendar();
      renderMonthlyReport();
    }

    function formatDateDot(dateKey) {
      if (!dateKey) return "";
      const [y, m, d] = dateKey.split("-");
      return `${y}.${m}.${d}`;
    }

    function startOfWeek(dateObj) {
      const d = new Date(dateObj);
      d.setHours(0, 0, 0, 0);
      d.setDate(d.getDate() - d.getDay());
      return d;
    }

    function dateKey(dateObj) {
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth() + 1).padStart(2, "0");
      const d = String(dateObj.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function isMonthKey(value) {
      return /^\d{4}-\d{2}$/.test(String(value || ""));
    }

    function formatMonthDot(monthKey) {
      if (!isMonthKey(monthKey)) return "";
      const [y, m] = monthKey.split("-");
      return `${y}.${m}`;
    }

    function shiftMonthKey(monthKey, offset) {
      if (!isMonthKey(monthKey)) return thisMonthKey();
      const [y, m] = monthKey.split("-").map(Number);
      const d = new Date(y, (m - 1) + offset, 1);
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
    }

    function setCalendarMonth(monthKey, persist = true) {
      if (!isMonthKey(monthKey)) return;
      state.calendarMonth = monthKey;
      if (el.calendarMonth) el.calendarMonth.value = monthKey;
      if (el.calendarMonthText) el.calendarMonthText.textContent = formatMonthDot(monthKey);
      if (persist) save();
      renderCalendar();
    }

    function setAnalysisMonth(monthKey, persist = true) {
      if (!isMonthKey(monthKey)) return;
      state.analysisMonth = monthKey;
      if (el.analysisMonth) el.analysisMonth.value = monthKey;
      if (el.analysisMonthText) el.analysisMonthText.textContent = formatMonthDot(monthKey);
      if (persist) save();
      renderAnalysis();
    }

    function getSundayWeekNumber(dateObj) {
      const yearStart = new Date(dateObj.getFullYear(), 0, 1);
      const firstSundayOffset = (7 - yearStart.getDay()) % 7;
      const firstSunday = new Date(dateObj.getFullYear(), 0, 1 + firstSundayOffset);
      if (dateObj < firstSunday) return 1;
      const diff = dateObj.getTime() - firstSunday.getTime();
      return Math.floor(diff / (7 * 24 * 60 * 60 * 1000)) + 1;
    }

    function shiftDateByDays(dKey, offsetDays) {
      const d = new Date(`${dKey}T00:00:00`);
      d.setDate(d.getDate() + offsetDays);
      return dateKey(d);
    }

    function hasJournalRecord(dKey) {
      const journal = getJournalForDate(dKey);
      return Boolean((journal.journalBody || "").trim() || journal.sticker);
    }

    function hasQuickNoteRecord(dKey) {
      return Boolean(getQuickNotesForDate(dKey).trim());
    }

    function getRoutineDoneCountForDate(dKey) {
      const day = state.routineLogs[dKey] || {};
      if (state.routines.length) {
        return state.routines.reduce((count, routine) => {
          return count + (isDoneValue(day[routine.id]) ? 1 : 0);
        }, 0);
      }
      return Object.values(day).filter((value) => isDoneValue(value)).length;
    }

    function moveToDate(dKey, targetTab = null) {
      if (!isDateKey(dKey)) return;
      state.selectedDate = dKey;
      state.calendarMonth = dKey.slice(0, 7);
      if (targetTab) setActiveTab(targetTab, false);
      syncRoutinesFromSelectedDate();
      save();
      syncInputs();
      renderTodos();
      renderRoutines();
      renderCalendar();
      renderSelectedDayTasks();
      renderMonthlyReport();
      renderAnalysis();
    }

    function renderWeekdayRow() {
      el.weekdayRow.innerHTML = WEEK_LABELS.map((d) => `<div class="weekday">${d}</div>`).join("");
    }

    function getDayCalendarSummary(dKey) {
      const dayTodos = state.todos.filter((t) => t.dueDate === dKey);
      const dayRoutine = state.routineLogs[dKey] || {};
      const routineTotal = state.routines.length || Object.keys(dayRoutine).length;
      return {
        todoCount: dayTodos.length,
        routineDone: getRoutineDoneCountForDate(dKey),
        routineTotal,
        journalLogged: hasJournalRecord(dKey),
        quickLogged: hasQuickNoteRecord(dKey)
      };
    }

    function renderCalendar() {
      const [year, month] = state.calendarMonth.split("-").map(Number);
      const first = new Date(year, month - 1, 1);
      const lastDay = new Date(year, month, 0).getDate();
      const startWeekday = first.getDay();
      const cells = [];

      for (let i = 0; i < startWeekday; i++) {
        cells.push('<div class="day-cell muted"></div>');
      }

      for (let day = 1; day <= lastDay; day++) {
        const dKey = `${year}-${String(month).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
        const summary = getDayCalendarSummary(dKey);
        const isToday = dKey === todayKey();
        const isSelected = dKey === state.selectedDate;
        const routineState = summary.routineDone <= 0
          ? "none"
          : (summary.routineTotal > 0 && summary.routineDone === summary.routineTotal ? "full" : "partial");
        const routineClass = routineState === "none" ? "" : `routine-${routineState}`;

        const metaHtml = `
          <div class="day-meta-grid">
            <span class="day-meta"><span>ì—…ë¬´</span><strong>${summary.todoCount}</strong></span>
            <span class="day-meta routine-meta ${routineState === "none" ? "" : routineState}"><span>ë£¨í‹´</span><strong>${summary.routineDone}/${summary.routineTotal}</strong></span>
            <span class="day-meta flag ${summary.journalLogged ? "" : "off"}" title="ì €ë„ ê¸°ë¡ ì—¬ë¶€"><span>J</span><strong>${summary.journalLogged ? "O" : "-"}</strong></span>
            <span class="day-meta flag ${summary.quickLogged ? "" : "off"}" title="í€µë…¸íŠ¸ ê¸°ë¡ ì—¬ë¶€"><span>Q</span><strong>${summary.quickLogged ? "O" : "-"}</strong></span>
          </div>
        `;
        cells.push(`
          <button class="day-cell ${isToday ? "today" : ""} ${isSelected ? "selected" : ""} ${routineClass}" data-date="${dKey}">
            <span class="day-num">${day}</span>
            ${metaHtml}
          </button>
        `);
      }

      el.calendarGrid.innerHTML = cells.join("");
    }

    function renderSelectedDayTasks() {
      if (!el.dayTaskTitle || !el.dayTaskList) return;
      const dKey = state.selectedDate;
      const dayTodos = state.todos.filter((t) => t.dueDate === dKey);
      const journal = getJournalForDate(dKey);
      el.dayTaskTitle.textContent = `${formatDateDot(dKey)} í•  ì¼`;

      if (!dayTodos.length) {
        const trail = journal.sticker ? `<div class="day-task">ì˜¤ëŠ˜ì˜ ìŠ¤í‹°ì»¤: ${escapeHTML(journal.sticker)}</div>` : "";
        el.dayTaskList.innerHTML = `${trail}<div class="sub">í•´ë‹¹ ë‚ ì§œì˜ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      const stickerHtml = journal.sticker ? `<div class="day-task">ì˜¤ëŠ˜ì˜ ìŠ¤í‹°ì»¤: ${escapeHTML(journal.sticker)}</div>` : "";
      el.dayTaskList.innerHTML = stickerHtml + dayTodos.map((todo) => {
        const status = todo.done ? "ì™„ë£Œ" : "ì§„í–‰ì¤‘";
        return `<div class="day-task">[${status}] ${escapeHTML(todo.text)}</div>`;
      }).join("");
    }

    function renderMonthlyReport() {
      // Monthly report UI removed from analysis tab.
    }

    function toMultilineHTML(text) {
      return escapeHTML(String(text || "")).replaceAll("\n", "<br>");
    }

    function renderAnalysis() {
      if (!el.analysisRoutineRows || !el.analysisJournalSummary || !el.analysisJournalDays || !el.analysisJournalEntries || !el.analysisQuickSummary || !el.analysisQuickDays || !el.analysisQuickEntries) {
        return;
      }

      const [year, month] = state.analysisMonth.split("-").map(Number);
      if (!year || !month) return;

      const monthPrefix = `${year}-${String(month).padStart(2, "0")}-`;
      const daysInMonth = new Date(year, month, 0).getDate();
      const startWeekday = new Date(year, month - 1, 1).getDay();
      const weekCount = Math.ceil((startWeekday + daysInMonth) / 7);

      if (!state.routines.length) {
        el.analysisRoutineRows.innerHTML = '<div class="analysis-record-item empty">ë£¨í‹´ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      } else {
        el.analysisRoutineRows.innerHTML = state.routines.map((routine) => {
          const weekLines = [];
          let monthlyDone = 0;

          for (let w = 0; w < weekCount; w++) {
            const dots = [];
            let weekDone = 0;
            let weekTotal = 0;
            let firstDate = null;

            for (let i = 0; i < 7; i++) {
              const cellIndex = (w * 7) + i;
              const day = (cellIndex - startWeekday) + 1;
              if (day < 1 || day > daysInMonth) {
                dots.push('<span class="routine-dot empty"></span>');
                continue;
              }

              const dKey = `${monthPrefix}${String(day).padStart(2, "0")}`;
              const done = isDoneValue(state.routineLogs[dKey] && state.routineLogs[dKey][routine.id]);
              if (!firstDate) firstDate = new Date(year, month - 1, day);
              weekTotal += 1;
              if (done) {
                weekDone += 1;
                monthlyDone += 1;
              }
              dots.push(`<span class="routine-dot ${done ? "done" : ""}" title="${dKey} ${done ? "ë‹¬ì„±" : "ë¯¸ë‹¬ì„±"}"></span>`);
            }

            const weekCountText = `${weekDone}/${weekTotal}`;
            const weekNo = firstDate ? getSundayWeekNumber(firstDate) : "";
            weekLines.push(`
              <div class="routine-week-line">
                <div class="routine-week-dots">${dots.join("")}</div>
                <span class="routine-week-rate">${weekNo ? `W${weekNo}` : "W-"} ${weekCountText}</span>
              </div>
            `);
          }

          const monthlyCountText = `${monthlyDone}/${daysInMonth}`;

          return `
            <article class="routine-analysis-card">
              <div class="routine-analysis-head">
                <strong>${escapeHTML(routine.name)}</strong>
                <span class="routine-month-rate">ì›”ê°„ ${monthlyCountText}</span>
              </div>
              <div class="routine-week-list">${weekLines.join("")}</div>
            </article>
          `;
        }).join("");
      }

      const journalRecords = [];
      const quickRecords = [];
      for (let day = 1; day <= daysInMonth; day++) {
        const dKey = `${monthPrefix}${String(day).padStart(2, "0")}`;
        const journal = getJournalForDate(dKey);
        const journalBody = String(journal.journalBody || "").trim();
        if (journal.sticker || journalBody) {
          journalRecords.push({
            day,
            key: dKey,
            sticker: journal.sticker || "",
            body: journalBody
          });
        }

        const quick = String(getQuickNotesForDate(dKey) || "").trim();
        if (quick) {
          quickRecords.push({
            day,
            key: dKey,
            body: quick
          });
        }
      }

      el.analysisJournalSummary.textContent = `Journal ê¸°ë¡ì¼: ${journalRecords.length}ì¼`;
      el.analysisQuickSummary.textContent = `Quick Note ê¸°ë¡ì¼: ${quickRecords.length}ì¼`;

      el.analysisJournalDays.innerHTML = journalRecords.length
        ? journalRecords.map((r) => `<span class="analysis-day">${r.day}ì¼</span>`).join("")
        : '<span class="analysis-day empty">ê¸°ë¡ ì—†ìŒ</span>';

      el.analysisQuickDays.innerHTML = quickRecords.length
        ? quickRecords.map((r) => `<span class="analysis-day">${r.day}ì¼</span>`).join("")
        : '<span class="analysis-day empty">ê¸°ë¡ ì—†ìŒ</span>';

      el.analysisJournalEntries.innerHTML = journalRecords.length
        ? journalRecords.map((record) => {
          const lines = [];
          if (record.sticker) lines.push(`ìŠ¤í‹°ì»¤: ${escapeHTML(record.sticker)}`);
          if (record.body) lines.push(toMultilineHTML(record.body));
          return `
            <article class="analysis-record-item">
              <strong>${record.key}</strong>
              ${lines.join("<br>")}
            </article>
          `;
        }).join("")
        : '<article class="analysis-record-item empty">ì €ë„ ê¸°ë¡ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</article>';

      el.analysisQuickEntries.innerHTML = quickRecords.length
        ? quickRecords.map((record) => `
            <article class="analysis-record-item">
              <strong>${record.key}</strong>
              ${toMultilineHTML(record.body)}
            </article>
          `).join("")
        : '<article class="analysis-record-item empty">í€µë…¸íŠ¸ ê¸°ë¡ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</article>';
    }

    function getNextGoalCategoryName() {
      const used = new Set(
        state.annualGoals
          .map((goal) => {
            const match = String(goal.title || "").trim().match(/^ì¹´í…Œê³ ë¦¬\s+(\d+)$/);
            return match ? Number(match[1]) : 0;
          })
          .filter((n) => n > 0)
      );
      let idx = 1;
      while (used.has(idx)) idx += 1;
      return `ì¹´í…Œê³ ë¦¬ ${idx}`;
    }

    function renderAnnualGoals() {
      if (!el.annualGoalList) return;
      if (!state.annualGoals.length) {
        el.annualGoalList.innerHTML = '<div class="goal-empty">ì¹´í…Œê³ ë¦¬ë¥¼ ì¶”ê°€í•´ ì—°ê°„ ëª©í‘œë¥¼ ì‘ì„±í•˜ì„¸ìš”.</div>';
        return;
      }

      el.annualGoalList.innerHTML = state.annualGoals.map((goal) => `
        <article class="goal-card" data-goal-id="${goal.id}">
          <div class="goal-head">
            <input
              class="goal-title"
              type="text"
              value="${escapeHTML(goal.title)}"
              placeholder="ì¹´í…Œê³ ë¦¬ ì´ë¦„ (ì˜ˆ: ê±´ê°•, ì»¤ë¦¬ì–´, ì¬ë¬´)"
              aria-label="ì—°ê°„ ëª©í‘œ ì¹´í…Œê³ ë¦¬"
              data-goal-field="title"
            >
            <button class="mini-btn" data-delete-goal="${goal.id}">ì‚­ì œ</button>
          </div>
          <textarea
            class="goal-content"
            rows="3"
            placeholder="í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ì—°ê°„ ëª©í‘œë¥¼ ì…ë ¥í•˜ì„¸ìš”."
            aria-label="ì—°ê°„ ëª©í‘œ ë‚´ìš©"
            data-goal-field="body"
          >${escapeHTML(goal.body)}</textarea>
        </article>
      `).join("");
    }

    function addAnnualGoalCategory() {
      state.annualGoals.push({
        ...createAnnualGoalCategory(),
        title: getNextGoalCategoryName(),
        body: ""
      });
      save();
      renderAnnualGoals();
    }

    function renderAnnualOverview() {
      const year = Number(state.annualYear) || new Date(state.selectedDate).getFullYear();
      const monthLabels = ["1ì›”","2ì›”","3ì›”","4ì›”","5ì›”","6ì›”","7ì›”","8ì›”","9ì›”","10ì›”","11ì›”","12ì›”"];
      let html = "";
      for (let m = 1; m <= 12; m++) {
        const mm = String(m).padStart(2, "0");
        const prefix = `${year}-${mm}-`;
        const daysInMonth = new Date(year, m, 0).getDate();
        let quickDays = 0;
        let journalDays = 0;
        let routineDoneTotal = 0;

        for (let day = 1; day <= daysInMonth; day++) {
          const dKey = `${prefix}${String(day).padStart(2, "0")}`;
          if (hasQuickNoteRecord(dKey)) quickDays += 1;
          if (hasJournalRecord(dKey)) journalDays += 1;
          routineDoneTotal += getRoutineDoneCountForDate(dKey);
        }

        const routineTotalPossible = daysInMonth * state.routines.length;
        const routineRate = routineTotalPossible ? Math.round((routineDoneTotal / routineTotalPossible) * 100) : 0;

        html += `
          <article class="annual-card" data-annual-month="${year}-${mm}">
            <h4>${monthLabels[m - 1]}</h4>
            <div class="annual-kpi">
              <span>í€µë…¸íŠ¸ ê¸°ë¡ì¼ <strong>${quickDays}ì¼</strong></span>
              <span>ì €ë„ ê¸°ë¡ì¼ <strong>${journalDays}ì¼</strong></span>
              <span>ë£¨í‹´ ë‹¬ì„±ìœ¨ <strong>${routineRate}%</strong></span>
            </div>
          </article>
        `;
      }
      el.annualGrid.innerHTML = html;
    }

    function bindTodoDragEvents() {
      const items = [...el.todoList.querySelectorAll(".todo-item[data-id]")];
      let draggedId = "";

      items.forEach((item) => {
        item.addEventListener("dragstart", () => {
          draggedId = item.dataset.id;
          item.classList.add("dragging");
        });

        item.addEventListener("dragend", () => {
          item.classList.remove("dragging");
        });

        item.addEventListener("dragover", (e) => {
          e.preventDefault();
        });

        item.addEventListener("drop", (e) => {
          e.preventDefault();
          const targetId = item.dataset.id;
          if (!draggedId || draggedId === targetId) return;

          const from = state.todos.findIndex((t) => t.id === draggedId);
          const to = state.todos.findIndex((t) => t.id === targetId);
          if (from === -1 || to === -1) return;

          const [moved] = state.todos.splice(from, 1);
          state.todos.splice(to, 0, moved);
          save();
          renderTodos();
        });
      });
    }

    function exportData() {
      const snapshot = buildStateSnapshot();
      const payload = {
        version: STORAGE_VERSION,
        exportedAt: new Date().toISOString(),
        data: snapshot
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "focus-ledger-backup.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function importData(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(reader.result);
          applyLoadedState(parsed, { forceToday: false });
          save();
          renderAll();
        } catch (err) {
          alert("ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: JSON íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.");
          console.warn(err);
        }
      };
      reader.readAsText(file, "utf-8");
    }

    function bindEvents() {
      el.tabButtons.forEach((btn) => {
        btn.addEventListener("click", () => setActiveTab(btn.dataset.tab));
      });

      el.loginBtn.addEventListener("click", async () => {
        if (!cloudEnabled || !cloudAuth) {
          alert("Firebase ì„¤ì • í›„ ë¡œê·¸ì¸ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
          return;
        }
        const email = el.authEmail.value.trim();
        const password = el.authPassword.value;
        if (!email || !password) {
          alert("ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
          return;
        }
        try {
          setSyncStatus("ë¡œê·¸ì¸ ì¤‘...", "saving");
          await cloudAuth.signInWithEmailAndPassword(email, password);
          el.authPassword.value = "";
        } catch (err) {
          console.warn(err);
          setSyncStatus("ë¡œê·¸ì¸ ì‹¤íŒ¨", "");
          alert(toAuthErrorMessage(err));
        }
      });

      el.signupBtn.addEventListener("click", async () => {
        if (!cloudEnabled || !cloudAuth) {
          alert("Firebase ì„¤ì • í›„ íšŒì›ê°€ì… ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
          return;
        }
        const email = el.authEmail.value.trim();
        const password = el.authPassword.value;
        if (!email || !password) {
          alert("ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
          return;
        }
        try {
          setSyncStatus("ê³„ì • ìƒì„± ì¤‘...", "saving");
          await cloudAuth.createUserWithEmailAndPassword(email, password);
          el.authPassword.value = "";
        } catch (err) {
          console.warn(err);
          setSyncStatus("íšŒì›ê°€ì… ì‹¤íŒ¨", "");
          alert(toAuthErrorMessage(err));
        }
      });

      el.logoutBtn.addEventListener("click", async () => {
        if (!cloudEnabled || !cloudAuth) return;
        try {
          await cloudAuth.signOut();
        } catch (err) {
          console.warn(err);
          alert("ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      });

      el.addTodoBtn.addEventListener("click", addTodo);
      el.todoInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          addTodo();
        }
      });
      el.quickTaskRow.addEventListener("click", (e) => {
        const btn = e.target.closest("[data-template]");
        if (!btn) return;
        addTodoByTemplate(btn.dataset.template);
      });

      el.addTagBtn.addEventListener("click", () => {});

      el.globalDatePicker.addEventListener("change", () => {
        if (!el.globalDatePicker.value) return;
        moveToDate(el.globalDatePicker.value);
      });

      el.prevDateBtn.addEventListener("click", () => {
        moveToDate(shiftDateByDays(state.selectedDate, -1));
      });

      el.nextDateBtn.addEventListener("click", () => {
        moveToDate(shiftDateByDays(state.selectedDate, 1));
      });

      el.todoList.addEventListener("click", (e) => {
        const actionEl = e.target.closest("[data-action]");
        if (!actionEl) return;

        const item = e.target.closest(".todo-item");
        if (!item) return;
        const id = item.dataset.id;
        const idx = state.todos.findIndex((t) => t.id === id);
        if (idx === -1) return;

        if (actionEl.dataset.action === "delete") {
          const deleted = state.todos[idx];
          state.todos.splice(idx, 1);
          state.todos
            .filter((t) => t.dueDate === deleted.dueDate && t.topOrder > 0)
            .sort((a, b) => a.topOrder - b.topOrder)
            .forEach((t, i) => { t.topOrder = i + 1; t.isTop = true; });
          save();
          renderTodos();
          renderCalendar();
          renderSelectedDayTasks();
          renderMonthlyReport();
          return;
        }

        if (actionEl.dataset.action === "top") {
          const targetTodo = state.todos[idx];
          const inDay = state.todos
            .filter((t) => t.dueDate === targetTodo.dueDate && t.topOrder > 0)
            .sort((a, b) => a.topOrder - b.topOrder);
          if (targetTodo.topOrder > 0) {
            targetTodo.topOrder = 0;
            targetTodo.isTop = false;
            inDay
              .filter((t) => t !== targetTodo)
              .forEach((t, i) => { t.topOrder = i + 1; t.isTop = true; });
          } else {
            if (inDay.length >= 3) {
              alert("Top3ëŠ” ìµœëŒ€ 3ê°œê¹Œì§€ ì§€ì •í•  ìˆ˜ ìˆì–´ìš”.");
              return;
            }
            targetTodo.topOrder = inDay.length + 1;
            targetTodo.isTop = true;
          }
          save();
          renderTodos();
          renderCalendar();
          renderSelectedDayTasks();
          renderMonthlyReport();
        }
      });

      el.todoList.addEventListener("change", (e) => {
        const actionEl = e.target.closest("[data-action='toggle']");
        if (!actionEl) return;
        const item = e.target.closest(".todo-item");
        if (!item) return;

        const todo = state.todos.find((t) => t.id === item.dataset.id);
        if (!todo) return;
        todo.done = actionEl.checked;
        save();
        renderTodos();
        renderCalendar();
        renderSelectedDayTasks();
        renderMonthlyReport();
      });

      el.filterChips.addEventListener("click", (e) => {
        const chip = e.target.closest(".chip");
        if (!chip) return;
        state.filter = chip.dataset.filter;
        save();
        syncInputs();
        renderTodos();
      });

      el.projectFilterChips.addEventListener("click", (e) => {
        const chip = e.target.closest("[data-project-filter]");
        if (!chip) return;
        state.projectFilter = chip.dataset.projectFilter;
        save();
        renderProjectFilters();
        renderTodos();
      });

      ["journalBody", "quickNotes"].forEach((key) => {
        el[key].addEventListener("input", () => {
          if (key === "quickNotes") {
            saveQuickNotesForSelectedDate(el[key].value);
          } else {
            saveJournalField(key, el[key].value);
          }
          save();
          updateStats();
          renderMonthlyReport();
        });
      });

      el.journalSticker.addEventListener("click", (e) => {
        const btn = e.target.closest("[data-sticker]");
        if (!btn) return;
        const current = getJournalForDate(state.selectedDate).sticker;
        const next = current === btn.dataset.sticker ? "" : btn.dataset.sticker;
        saveJournalField("sticker", next);
        save();
        syncInputs();
        renderSelectedDayTasks();
        renderMonthlyReport();
      });

      el.routineList.addEventListener("input", (e) => {
        const nameInput = e.target.closest(".routine-name");
        if (!nameInput) return;
        const row = e.target.closest("[data-rid]");
        if (!row) return;
        const routine = state.routines.find((r) => r.id === row.dataset.rid);
        if (!routine) return;
        routine.name = nameInput.value;
        save();
      });

      el.routineList.addEventListener("click", (e) => {
        const toggleBtn = e.target.closest("[data-toggle-routine]");
        if (toggleBtn) {
          const rid = toggleBtn.dataset.toggleRoutine;
          const routine = state.routines.find((r) => r.id === rid);
          if (!routine) return;
          routine.done = !routine.done;
          save();
          renderRoutines();
          renderCalendar();
          renderMonthlyReport();
          return;
        }

        const delBtn = e.target.closest("[data-delete-routine]");
        if (!delBtn) return;
        const rid = delBtn.dataset.deleteRoutine;
        state.routines = state.routines.filter((r) => r.id !== rid);
        Object.keys(state.routineLogs).forEach((k) => {
          if (state.routineLogs[k] && rid in state.routineLogs[k]) {
            delete state.routineLogs[k][rid];
          }
        });
        save();
        renderRoutines();
        renderCalendar();
        renderMonthlyReport();
      });

      el.addRoutineBtn.addEventListener("click", addRoutine);
      el.routineInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          addRoutine();
        }
      });
      el.routineTemplateRow.addEventListener("click", (e) => {
        const btn = e.target.closest("[data-routines]");
        if (!btn) return;
        addRoutineTemplate(btn.dataset.routines);
      });

      el.calendarPrevMonthBtn.addEventListener("click", () => {
        setCalendarMonth(shiftMonthKey(state.calendarMonth, -1));
      });

      el.calendarNextMonthBtn.addEventListener("click", () => {
        setCalendarMonth(shiftMonthKey(state.calendarMonth, 1));
      });

      el.analysisPrevMonthBtn.addEventListener("click", () => {
        setAnalysisMonth(shiftMonthKey(state.analysisMonth, -1));
      });

      el.analysisNextMonthBtn.addEventListener("click", () => {
        setAnalysisMonth(shiftMonthKey(state.analysisMonth, 1));
      });

      el.annualYear.addEventListener("change", () => {
        const y = Number(el.annualYear.value);
        if (!y || y < 2000 || y > 2100) return;
        state.annualYear = y;
        save();
        renderAnnualOverview();
      });

      if (el.addAnnualGoalBtn) {
        el.addAnnualGoalBtn.addEventListener("click", addAnnualGoalCategory);
      }

      if (el.annualGoalList) {
        el.annualGoalList.addEventListener("input", (e) => {
          const field = e.target.closest("[data-goal-field]");
          if (!field) return;
          const card = e.target.closest("[data-goal-id]");
          if (!card) return;
          const goal = state.annualGoals.find((item) => item.id === card.dataset.goalId);
          if (!goal) return;
          const key = field.dataset.goalField;
          if (key === "title") {
            goal.title = field.value;
          } else if (key === "body") {
            goal.body = field.value;
          } else {
            return;
          }
          save();
        });

        el.annualGoalList.addEventListener("click", (e) => {
          const delBtn = e.target.closest("[data-delete-goal]");
          if (!delBtn) return;
          const gid = delBtn.dataset.deleteGoal;
          state.annualGoals = state.annualGoals.filter((goal) => goal.id !== gid);
          save();
          renderAnnualGoals();
        });
      }

      el.calendarGrid.addEventListener("click", (e) => {
        const cell = e.target.closest(".day-cell[data-date]");
        if (!cell) return;
        moveToDate(cell.dataset.date, "dashboard");
      });

      el.annualGrid.addEventListener("click", (e) => {
        const card = e.target.closest("[data-annual-month]");
        if (!card) return;
        const [y, m] = card.dataset.annualMonth.split("-").map(Number);
        const targetDate = `${y}-${String(m).padStart(2, "0")}-01`;
        moveToDate(targetDate, "calendar");
      });

      document.addEventListener("visibilitychange", () => {
        if (document.visibilityState !== "visible") return;
        resetToTodayIfDateRolledOver();
      });

      el.exportBtn.addEventListener("click", exportData);
      el.importBtn.addEventListener("click", () => el.importFile.click());
      el.importFile.addEventListener("change", () => {
        const file = el.importFile.files && el.importFile.files[0];
        if (file) importData(file);
        el.importFile.value = "";
      });
    }

    load({ allowLegacyGuest: true, forceToday: false, forceLandingCalendar: true });
    renderWeekdayRow();
    renderAll();
    bindEvents();
    updateAuthUI();
    initCloud();
  </script>
</body>
</html>
